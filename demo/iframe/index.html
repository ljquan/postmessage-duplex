<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Iframe é€šè®¯ç¤ºä¾‹ - postmessage-channel</title>
  <script src="/dist/index.umd.js"></script>
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
    }
    .header h1 {
      margin: 0 0 8px;
      font-size: 1.5rem;
    }
    .header p {
      margin: 0;
      opacity: 0.9;
      font-size: 0.9rem;
    }
    .header a {
      color: white;
      opacity: 0.8;
    }
    .main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    @media (max-width: 900px) {
      .main { grid-template-columns: 1fr; }
    }
    .panel {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .panel-header {
      background: #f8f9fa;
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
      font-weight: 600;
      color: #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .panel-body {
      padding: 16px;
    }
    .iframe-wrapper {
      border: 2px dashed #ddd;
      border-radius: 4px;
      min-height: 200px;
    }
    .iframe-wrapper iframe {
      width: 100%;
      height: 200px;
      border: none;
      display: block;
    }
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    button.primary {
      background: #007bff;
      color: white;
    }
    button.primary:hover { background: #0056b3; }
    button.success {
      background: #28a745;
      color: white;
    }
    button.success:hover { background: #1e7e34; }
    button.warning {
      background: #ffc107;
      color: #333;
    }
    button.warning:hover { background: #e0a800; }
    input[type="text"] {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      flex: 1;
      min-width: 150px;
    }
    .log {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 12px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
    }
    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid #333;
    }
    .log-entry:last-child { border-bottom: none; }
    .log-time { color: #888; }
    .log-send { color: #4ec9b0; }
    .log-receive { color: #dcdcaa; }
    .log-info { color: #9cdcfe; }
    .log-error { color: #f48771; }
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 16px;
    }
    .stat-card {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      text-align: center;
    }
    .stat-card .value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
    }
    .stat-card .label {
      font-size: 0.8rem;
      color: #666;
      margin-top: 4px;
    }
    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      background: #28a745;
      color: white;
    }
    .badge.pending {
      background: #ffc107;
      color: #333;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>ğŸ–¼ï¸ Iframe åŒå·¥é€šè®¯ç¤ºä¾‹</h1>
    <p><a href="../">â† è¿”å›</a> | çˆ¶é¡µé¢ä¸å­ iframe ä¹‹é—´çš„åŒå‘æ¶ˆæ¯ä¼ é€’</p>
  </div>

  <div class="main">
    <div class="panel">
      <div class="panel-header">
        å­é¡µé¢ 1
        <span id="son1-status" class="badge pending">ç­‰å¾…è¿æ¥</span>
      </div>
      <div class="panel-body">
        <div class="iframe-wrapper">
          <iframe id="son1" src="./child.html"></iframe>
        </div>
        <div class="controls" style="margin-top: 16px;">
          <input type="text" id="msg1" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹" value="Hello from parent!" />
          <button class="primary" onclick="sendToSon1()">å‘é€æ¶ˆæ¯</button>
          <button class="success" onclick="pingTest1()">Ping æµ‹è¯•</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        å­é¡µé¢ 2
        <span id="son2-status" class="badge pending">ç­‰å¾…è¿æ¥</span>
      </div>
      <div class="panel-body">
        <div class="iframe-wrapper">
          <iframe id="son2" src="./child.html"></iframe>
        </div>
        <div class="controls" style="margin-top: 16px;">
          <input type="text" id="msg2" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹" value="Hello from parent!" />
          <button class="primary" onclick="sendToSon2()">å‘é€æ¶ˆæ¯</button>
          <button class="success" onclick="pingTest2()">Ping æµ‹è¯•</button>
        </div>
      </div>
    </div>

    <div class="panel" style="grid-column: 1 / -1;">
      <div class="panel-header">
        é€šè®¯æ—¥å¿—
        <button class="warning" onclick="clearLog()" style="padding: 4px 12px;">æ¸…ç©º</button>
      </div>
      <div class="panel-body">
        <div class="controls">
          <button class="primary" onclick="broadcastMessage()">å¹¿æ’­æ¶ˆæ¯ï¼ˆå‘é€ç»™æ‰€æœ‰å­é¡µé¢ï¼‰</button>
          <button class="success" onclick="performanceTest()">æ€§èƒ½æµ‹è¯•ï¼ˆ1ç§’å†…æ”¶å‘æ¬¡æ•°ï¼‰</button>
          <button class="warning" onclick="showTrace()">æŸ¥çœ‹æ¶ˆæ¯è¿½è¸ª</button>
        </div>
        <div id="log" class="log"></div>
        <div class="stats">
          <div class="stat-card">
            <div class="value" id="stat-sent">0</div>
            <div class="label">å‘é€æ¶ˆæ¯æ•°</div>
          </div>
          <div class="stat-card">
            <div class="value" id="stat-received">0</div>
            <div class="label">æ¥æ”¶æ¶ˆæ¯æ•°</div>
          </div>
          <div class="stat-card">
            <div class="value" id="stat-rps">-</div>
            <div class="label">æ¶ˆæ¯/ç§’</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    var IframeChannel = window.PostMessageChannel.IframeChannel;
    var ps1, ps2;
    var sentCount = 0, receivedCount = 0;

    // æ—¥å¿—å·¥å…·
    function log(type, source, message, data) {
      var logEl = document.getElementById('log');
      var time = new Date().toLocaleTimeString();
      var entry = document.createElement('div');
      entry.className = 'log-entry';
      var content = '<span class="log-time">[' + time + ']</span> ';
      content += '<span class="log-' + type + '">[' + source + '] ' + message;
      if (data !== undefined) {
        content += ': ' + JSON.stringify(data);
      }
      content += '</span>';
      entry.innerHTML = content;
      logEl.insertBefore(entry, logEl.firstChild);
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    function updateStats() {
      document.getElementById('stat-sent').textContent = sentCount;
      document.getElementById('stat-received').textContent = receivedCount;
    }

    // åˆå§‹åŒ–å­é¡µé¢1çš„é€šé“
    var iframe1 = document.getElementById('son1');
    ps1 = new IframeChannel(iframe1, {
      timeout: 5000,
      subscribeMap: {
        'message': function(payload) {
          receivedCount++;
          updateStats();
          log('receive', 'å­é¡µé¢1', 'æ”¶åˆ°æ¶ˆæ¯', payload.data);
          return { received: true, from: 'parent' };
        },
        'ping': function() {
          return { pong: true, timestamp: Date.now() };
        }
      }
    });

    // ç›‘å¬ ready çŠ¶æ€
    var checkReady1 = setInterval(function() {
      if (ps1.isReady) {
        document.getElementById('son1-status').className = 'badge';
        document.getElementById('son1-status').textContent = 'å·²è¿æ¥';
        log('info', 'å­é¡µé¢1', 'è¿æ¥æˆåŠŸ');
        clearInterval(checkReady1);
      }
    }, 100);

    // åˆå§‹åŒ–å­é¡µé¢2çš„é€šé“
    var iframe2 = document.getElementById('son2');
    ps2 = new IframeChannel(iframe2, {
      timeout: 5000,
      subscribeMap: {
        'message': function(payload) {
          receivedCount++;
          updateStats();
          log('receive', 'å­é¡µé¢2', 'æ”¶åˆ°æ¶ˆæ¯', payload.data);
          return { received: true, from: 'parent' };
        },
        'ping': function() {
          return { pong: true, timestamp: Date.now() };
        }
      }
    });

    var checkReady2 = setInterval(function() {
      if (ps2.isReady) {
        document.getElementById('son2-status').className = 'badge';
        document.getElementById('son2-status').textContent = 'å·²è¿æ¥';
        log('info', 'å­é¡µé¢2', 'è¿æ¥æˆåŠŸ');
        clearInterval(checkReady2);
      }
    }, 100);

    // å‘é€æ¶ˆæ¯
    function sendToSon1() {
      var msg = document.getElementById('msg1').value;
      sentCount++;
      updateStats();
      log('send', 'å­é¡µé¢1', 'å‘é€æ¶ˆæ¯', { content: msg });
      ps1.publish('message', { content: msg, time: Date.now() }).then(function(res) {
        receivedCount++;
        updateStats();
        log('receive', 'å­é¡µé¢1', 'æ”¶åˆ°å“åº”', res);
      });
    }

    function sendToSon2() {
      var msg = document.getElementById('msg2').value;
      sentCount++;
      updateStats();
      log('send', 'å­é¡µé¢2', 'å‘é€æ¶ˆæ¯', { content: msg });
      ps2.publish('message', { content: msg, time: Date.now() }).then(function(res) {
        receivedCount++;
        updateStats();
        log('receive', 'å­é¡µé¢2', 'æ”¶åˆ°å“åº”', res);
      });
    }

    function pingTest1() {
      var start = Date.now();
      sentCount++;
      updateStats();
      log('send', 'å­é¡µé¢1', 'Ping å‘é€');
      ps1.publish('ping').then(function(res) {
        var latency = Date.now() - start;
        receivedCount++;
        updateStats();
        log('receive', 'å­é¡µé¢1', 'Pong æ”¶åˆ°ï¼Œå»¶è¿Ÿ: ' + latency + 'ms', res);
      });
    }

    function pingTest2() {
      var start = Date.now();
      sentCount++;
      updateStats();
      log('send', 'å­é¡µé¢2', 'Ping å‘é€');
      ps2.publish('ping').then(function(res) {
        var latency = Date.now() - start;
        receivedCount++;
        updateStats();
        log('receive', 'å­é¡µé¢2', 'Pong æ”¶åˆ°ï¼Œå»¶è¿Ÿ: ' + latency + 'ms', res);
      });
    }

    function broadcastMessage() {
      var msg = 'å¹¿æ’­æ¶ˆæ¯ @ ' + new Date().toLocaleTimeString();
      log('send', 'å¹¿æ’­', 'å‘é€ç»™æ‰€æœ‰å­é¡µé¢', { content: msg });
      sentCount += 2;
      updateStats();
      Promise.all([
        ps1.publish('message', { content: msg, broadcast: true }),
        ps2.publish('message', { content: msg, broadcast: true })
      ]).then(function(results) {
        receivedCount += 2;
        updateStats();
        log('receive', 'å¹¿æ’­', 'æ‰€æœ‰å­é¡µé¢å“åº”å®Œæˆ');
      });
    }

    function performanceTest() {
      log('info', 'æ€§èƒ½æµ‹è¯•', 'å¼€å§‹ 1 ç§’å†…æ”¶å‘æµ‹è¯•...');
      var count = 0;
      var running = true;
      setTimeout(function() { running = false; }, 1000);

      (async function run() {
        while (running) {
          await ps1.publish('ping');
          count++;
        }
        document.getElementById('stat-rps').textContent = count;
        log('info', 'æ€§èƒ½æµ‹è¯•', 'å®Œæˆï¼Œæ¯ç§’æ¶ˆæ¯æ•°: ' + count);
      })();
    }

    function showTrace() {
      // ä½¿ç”¨æ–°çš„è°ƒè¯•å™¨ API
      if (window.__POSTMESSAGE_DUPLEX__ && window.__POSTMESSAGE_DUPLEX__.debug) {
        window.__POSTMESSAGE_DUPLEX__.debug.getHistory();
        log('info', 'è¿½è¸ª', 'å·²è¾“å‡ºåˆ°æ§åˆ¶å°');
      } else {
        log('warn', 'è¿½è¸ª', 'è°ƒè¯•å™¨æœªå¯ç”¨ï¼Œè¯·å…ˆè°ƒç”¨ enableDebugger()');
      }
    }
  </script>
</body>

</html>
