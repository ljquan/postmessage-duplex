<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iframe å¤šé¡µé¢é€šè®¯æ¼”ç¤º - postmessage-duplex</title>
  <script src="./postmessage-duplex.umd.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      color: white;
      padding: 20px;
    }
    .header h1 {
      margin: 0 0 8px;
      font-size: 1.5rem;
    }
    .header p {
      margin: 0;
      opacity: 0.9;
      font-size: 0.9rem;
    }
    .header a {
      color: white;
      opacity: 0.8;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    .description {
      background: white;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .description h2 {
      font-size: 1.1rem;
      margin-bottom: 12px;
      color: #2c3e50;
    }
    .description ul {
      margin: 0;
      padding-left: 20px;
      color: #666;
      font-size: 0.9rem;
    }
    .description li {
      margin-bottom: 4px;
    }
    .iframe-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }
    @media (max-width: 900px) {
      .iframe-grid { grid-template-columns: 1fr; }
    }
    .iframe-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .iframe-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #f8f9fa;
      border-bottom: 1px solid #eee;
    }
    .iframe-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .app-badge {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }
    .app-badge.cart { background: #667eea; }
    .app-badge.user { background: #f5576c; }
    .iframe-actions {
      display: flex;
      gap: 8px;
    }
    .iframe-wrapper {
      height: 400px;
    }
    .iframe-wrapper iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .hub-panel {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .hub-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: white;
    }
    .hub-body {
      padding: 16px;
    }
    .section {
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: #666;
      margin-bottom: 8px;
    }
    .btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }
    button:hover { opacity: 0.9; }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-sm {
      padding: 4px 10px;
      font-size: 12px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    .stat-card {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #2c3e50;
    }
    .stat-label {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }
    .log-container {
      background: #1e1e1e;
      border-radius: 6px;
      padding: 12px;
      max-height: 250px;
      overflow-y: auto;
      font-family: Monaco, Consolas, monospace;
      font-size: 12px;
      color: #d4d4d4;
    }
    .log-item {
      padding: 4px 0;
      border-bottom: 1px solid #333;
    }
    .log-item:last-child { border-bottom: none; }
    .log-time { color: #888; }
    .log-send { color: #4ec9b0; }
    .log-receive { color: #dcdcaa; }
    .log-broadcast { color: #ce9178; }
    .log-error { color: #f48771; }
    .log-info { color: #9cdcfe; }
    .clients-list {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 12px;
      font-size: 13px;
    }
    .client-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: white;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    .client-item:last-child { margin-bottom: 0; }
    .client-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .client-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #28a745;
    }
    .client-type {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      background: #e9ecef;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ–¼ï¸ Iframe å¤šé¡µé¢é€šè®¯æ¼”ç¤º</h1>
    <p><a href="./">â† è¿”å›</a> | çˆ¶é¡µé¢ä½œä¸º Hub ç®¡ç†å¤šä¸ªå­ iframe çš„é€šè®¯</p>
  </div>
  
  <div class="container">
    <div class="description">
      <h2>é€šè®¯æ¨¡å¼è¯´æ˜</h2>
      <ul>
        <li><strong>ç‚¹å¯¹ç‚¹é€šè®¯</strong>ï¼šçˆ¶é¡µé¢ â†” å­é¡µé¢ï¼Œæœ‰è¯·æ±‚-å“åº”</li>
        <li><strong>å­é¡µé¢é—´é€šè®¯</strong>ï¼šå­é¡µé¢ A â†’ çˆ¶é¡µé¢(Hub) â†’ å­é¡µé¢ B</li>
        <li><strong>å¹¿æ’­é€šè®¯</strong>ï¼šçˆ¶é¡µé¢ â†’ æ‰€æœ‰å­é¡µé¢ï¼ˆå•å‘ï¼Œæ— å“åº”ï¼‰</li>
        <li><strong>ç±»å‹å¹¿æ’­</strong>ï¼šçˆ¶é¡µé¢ â†’ æŒ‡å®šç±»å‹çš„å­é¡µé¢ï¼ˆå¦‚åªç»™è´­ç‰©è½¦å¹¿æ’­ï¼‰</li>
      </ul>
    </div>
    
    <div class="iframe-grid">
      <div class="iframe-container">
        <div class="iframe-header">
          <div class="iframe-title">
            <span class="app-badge cart">åº”ç”¨ 1</span>
            <strong>è´­ç‰©è½¦æ¨¡å—</strong>
          </div>
          <div class="iframe-actions">
            <button class="btn-secondary btn-sm" onclick="reloadIframe('iframe1')">åˆ·æ–°</button>
            <button class="btn-info btn-sm" onclick="window.open('./iframe-child1.html')">æ–°çª—å£</button>
          </div>
        </div>
        <div class="iframe-wrapper">
          <iframe id="iframe1" src="./iframe-child1.html"></iframe>
        </div>
      </div>
      
      <div class="iframe-container">
        <div class="iframe-header">
          <div class="iframe-title">
            <span class="app-badge user">åº”ç”¨ 2</span>
            <strong>ç”¨æˆ·ä¸­å¿ƒ</strong>
          </div>
          <div class="iframe-actions">
            <button class="btn-secondary btn-sm" onclick="reloadIframe('iframe2')">åˆ·æ–°</button>
            <button class="btn-info btn-sm" onclick="window.open('./iframe-child2.html')">æ–°çª—å£</button>
          </div>
        </div>
        <div class="iframe-wrapper">
          <iframe id="iframe2" src="./iframe-child2.html"></iframe>
        </div>
      </div>
    </div>
    
    <div class="hub-panel">
      <div class="hub-header">
        <span>ğŸ›ï¸ Hub æ§åˆ¶é¢æ¿ï¼ˆçˆ¶é¡µé¢ï¼‰</span>
        <span id="hubStatus">è¿è¡Œä¸­</span>
      </div>
      <div class="hub-body">
        <div class="stats">
          <div class="stat-card">
            <div class="stat-value" id="clientCount">0</div>
            <div class="stat-label">å·²è¿æ¥å®¢æˆ·ç«¯</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="msgSent">0</div>
            <div class="stat-label">å‘é€æ¶ˆæ¯</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="msgReceived">0</div>
            <div class="stat-label">æ¥æ”¶æ¶ˆæ¯</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="msgForwarded">0</div>
            <div class="stat-label">è½¬å‘æ¶ˆæ¯</div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-title">ç‚¹å¯¹ç‚¹æ“ä½œ</div>
          <div class="btn-group">
            <button class="btn-primary" onclick="pingAll()">Ping æ‰€æœ‰å®¢æˆ·ç«¯</button>
            <button class="btn-success" onclick="sendToCart()">å‘é€ç»™è´­ç‰©è½¦</button>
            <button class="btn-success" onclick="sendToUser()">å‘é€ç»™ç”¨æˆ·ä¸­å¿ƒ</button>
          </div>
        </div>
        
        <div class="section">
          <div class="section-title">å¹¿æ’­æ“ä½œ</div>
          <div class="btn-group">
            <button class="btn-warning" onclick="broadcastAll()">å¹¿æ’­ç»™æ‰€æœ‰</button>
            <button class="btn-warning" onclick="broadcastToCart()">å¹¿æ’­ç»™è´­ç‰©è½¦</button>
            <button class="btn-warning" onclick="broadcastToUser()">å¹¿æ’­ç»™ç”¨æˆ·ä¸­å¿ƒ</button>
          </div>
        </div>
        
        <div class="section">
          <div class="section-title">å·²è¿æ¥å®¢æˆ·ç«¯</div>
          <div id="clientsList" class="clients-list">
            <div style="color: #999; text-align: center; padding: 16px;">ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥...</div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-title">
            é€šè®¯æ—¥å¿—
            <button class="btn-secondary btn-sm" onclick="clearLog()" style="float: right;">æ¸…ç©º</button>
          </div>
          <div id="logContainer" class="log-container"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { IframeChannel, ReturnCode } = PostMessageChannel;
    
    // ========== Hub çŠ¶æ€ç®¡ç† ==========
    const clientMeta = new Map();  // iframeId -> { appType, appName, channel }
    const stats = { sent: 0, received: 0, forwarded: 0 };
    
    // DOM elements
    const logContainer = document.getElementById('logContainer');
    const clientCountEl = document.getElementById('clientCount');
    const msgSentEl = document.getElementById('msgSent');
    const msgReceivedEl = document.getElementById('msgReceived');
    const msgForwardedEl = document.getElementById('msgForwarded');
    const clientsListEl = document.getElementById('clientsList');
    
    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const item = document.createElement('div');
      item.className = 'log-item';
      item.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
      logContainer.appendChild(item);
      logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    function clearLog() {
      logContainer.innerHTML = '';
    }
    
    function updateStats() {
      clientCountEl.textContent = clientMeta.size;
      msgSentEl.textContent = stats.sent;
      msgReceivedEl.textContent = stats.received;
      msgForwardedEl.textContent = stats.forwarded;
    }
    
    function updateClientsList() {
      if (clientMeta.size === 0) {
        clientsListEl.innerHTML = '<div style="color: #999; text-align: center; padding: 16px;">ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥...</div>';
        return;
      }
      
      clientsListEl.innerHTML = '';
      for (const [iframeId, meta] of clientMeta) {
        const item = document.createElement('div');
        item.className = 'client-item';
        item.innerHTML = `
          <div class="client-info">
            <span class="client-status"></span>
            <strong>${meta.appName || iframeId}</strong>
            <span class="client-type">${meta.appType || 'unknown'}</span>
          </div>
          <span style="color: #999; font-size: 11px;">${iframeId}</span>
        `;
        clientsListEl.appendChild(item);
      }
    }
    
    // ========== åˆ›å»º Channel çš„é€šç”¨å‡½æ•° ==========
    function createChannelForIframe(iframeId, iframe) {
      const channel = new IframeChannel(iframe, {
        timeout: 5000
      });
      
      // ç›‘å¬ ready äº‹ä»¶
      channel.on('ready', () => {
        log(`[${iframeId}] iframe å·²è¿æ¥`, 'info');
      });
      
      // æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨
      
      // å®¢æˆ·ç«¯æ³¨å†Œ
      channel.subscribe('__register__', ({ data }) => {
        stats.received++;
        const meta = {
          appType: data.appType,
          appName: data.appName,
          channel: channel,
          connectedAt: new Date().toISOString()
        };
        clientMeta.set(iframeId, meta);
        updateStats();
        updateClientsList();
        log(`[${iframeId}] å®¢æˆ·ç«¯æ³¨å†Œ: ${data.appName} (${data.appType})`, 'info');
        return { success: true, totalClients: clientMeta.size };
      });
      
      // Ping
      channel.subscribe('ping', () => {
        stats.received++;
        updateStats();
        return { pong: true, from: 'Hub', timestamp: Date.now() };
      });
      
      // ç‚¹å¯¹ç‚¹æ¶ˆæ¯ï¼ˆçˆ¶é¡µé¢å¤„ç†ï¼‰
      channel.subscribe('directMessage', ({ data }) => {
        stats.received++;
        updateStats();
        log(`ğŸ“¥ [ç‚¹å¯¹ç‚¹] æ¥è‡ª ${data.from}: ${data.message}`, 'receive');
        return { received: true, from: 'Hub' };
      });
      
      // è½¬å‘ç»™æŒ‡å®šç±»å‹
      channel.subscribe('forwardToType', async ({ data }) => {
        stats.received++;
        const { targetType, cmdname, data: payload } = data;
        let sentCount = 0;
        
        for (const [id, meta] of clientMeta) {
          if (meta.appType === targetType && id !== iframeId) {
            try {
              await meta.channel.publish(cmdname, payload);
              stats.forwarded++;
              sentCount++;
            } catch (e) {
              log(`è½¬å‘å¤±è´¥ [${id}]: ${e.message}`, 'error');
            }
          }
        }
        
        updateStats();
        log(`ğŸ”€ è½¬å‘ç»™ ${targetType}: ${sentCount} ä¸ªå®¢æˆ·ç«¯`, 'info');
        return { success: true, sentCount };
      });
      
      // å¹¿æ’­ç»™æ‰€æœ‰
      channel.subscribe('broadcastToAll', ({ data }) => {
        stats.received++;
        const { eventName, data: payload } = data;
        let sentCount = 0;
        
        for (const [id, meta] of clientMeta) {
          if (id !== iframeId) {
            meta.channel.broadcast(eventName, payload);
            stats.forwarded++;
            sentCount++;
          }
        }
        
        updateStats();
        log(`ğŸ“¢ å¹¿æ’­ç»™æ‰€æœ‰: ${sentCount} ä¸ªå®¢æˆ·ç«¯`, 'broadcast');
        return { success: true, sentCount };
      });
      
      // å¹¿æ’­ç»™æŒ‡å®šç±»å‹
      channel.subscribe('broadcastToType', ({ data }) => {
        stats.received++;
        const { targetType, eventName, data: payload } = data;
        let sentCount = 0;
        
        for (const [id, meta] of clientMeta) {
          if (meta.appType === targetType && id !== iframeId) {
            meta.channel.broadcast(eventName, payload);
            stats.forwarded++;
            sentCount++;
          }
        }
        
        updateStats();
        log(`ğŸ¯ å¹¿æ’­ç»™ ${targetType}: ${sentCount} ä¸ªå®¢æˆ·ç«¯`, 'broadcast');
        return { success: true, sentCount };
      });
      
      return channel;
    }
    
    // ========== åˆå§‹åŒ– iframe channels ==========
    const iframe1 = document.getElementById('iframe1');
    const iframe2 = document.getElementById('iframe2');
    
    const channel1 = createChannelForIframe('iframe1', iframe1);
    const channel2 = createChannelForIframe('iframe2', iframe2);
    
    // ========== Hub æ“ä½œå‡½æ•° ==========
    
    function pingAll() {
      log('ğŸ“¤ Ping æ‰€æœ‰å®¢æˆ·ç«¯...', 'send');
      for (const [id, meta] of clientMeta) {
        stats.sent++;
        const start = Date.now();
        meta.channel.publish('ping').then(res => {
          stats.received++;
          const latency = Date.now() - start;
          updateStats();
          log(`ğŸ“¥ [${meta.appName}] Pong! å»¶è¿Ÿ: ${latency}ms`, 'receive');
        });
      }
      updateStats();
    }
    
    function sendToCart() {
      const message = `Hub æ¶ˆæ¯ @ ${new Date().toLocaleTimeString()}`;
      log(`ğŸ“¤ å‘é€ç»™è´­ç‰©è½¦: ${message}`, 'send');
      
      for (const [id, meta] of clientMeta) {
        if (meta.appType === 'cart') {
          stats.sent++;
          meta.channel.publish('directMessage', {
            message: message,
            from: 'Hub'
          }).then(res => {
            stats.received++;
            updateStats();
            log(`ğŸ“¥ [${meta.appName}] å·²æ”¶åˆ°`, 'receive');
          });
        }
      }
      updateStats();
    }
    
    function sendToUser() {
      const message = `Hub æ¶ˆæ¯ @ ${new Date().toLocaleTimeString()}`;
      log(`ğŸ“¤ å‘é€ç»™ç”¨æˆ·ä¸­å¿ƒ: ${message}`, 'send');
      
      for (const [id, meta] of clientMeta) {
        if (meta.appType === 'user') {
          stats.sent++;
          meta.channel.publish('directMessage', {
            message: message,
            from: 'Hub'
          }).then(res => {
            stats.received++;
            updateStats();
            log(`ğŸ“¥ [${meta.appName}] å·²æ”¶åˆ°`, 'receive');
          });
        }
      }
      updateStats();
    }
    
    function broadcastAll() {
      const message = `Hub å¹¿æ’­ @ ${new Date().toLocaleTimeString()}`;
      log(`ğŸ“¢ å¹¿æ’­ç»™æ‰€æœ‰: ${message}`, 'broadcast');
      
      for (const [id, meta] of clientMeta) {
        stats.sent++;
        meta.channel.broadcast('globalBroadcast', {
          message: message,
          from: 'Hub'
        });
      }
      updateStats();
    }
    
    function broadcastToCart() {
      const message = `è´­ç‰©è½¦ä¸“å±å¹¿æ’­ @ ${new Date().toLocaleTimeString()}`;
      log(`ğŸ¯ å¹¿æ’­ç»™è´­ç‰©è½¦: ${message}`, 'broadcast');
      
      for (const [id, meta] of clientMeta) {
        if (meta.appType === 'cart') {
          stats.sent++;
          meta.channel.broadcast('typedBroadcast', {
            message: message,
            from: 'Hub',
            targetType: 'cart'
          });
        }
      }
      updateStats();
    }
    
    function broadcastToUser() {
      const message = `ç”¨æˆ·ä¸­å¿ƒä¸“å±å¹¿æ’­ @ ${new Date().toLocaleTimeString()}`;
      log(`ğŸ¯ å¹¿æ’­ç»™ç”¨æˆ·ä¸­å¿ƒ: ${message}`, 'broadcast');
      
      for (const [id, meta] of clientMeta) {
        if (meta.appType === 'user') {
          stats.sent++;
          meta.channel.broadcast('typedBroadcast', {
            message: message,
            from: 'Hub',
            targetType: 'user'
          });
        }
      }
      updateStats();
    }
    
    function reloadIframe(iframeId) {
      const iframe = document.getElementById(iframeId);
      const meta = clientMeta.get(iframeId);
      
      // æ¸…ç†æ—§çš„ channel
      if (meta) {
        meta.channel.destroy();
        clientMeta.delete(iframeId);
        updateClientsList();
        log(`[${iframeId}] å®¢æˆ·ç«¯æ–­å¼€`, 'info');
      }
      
      // é‡æ–°åŠ è½½ iframe
      iframe.src = iframe.src;
      
      // é‡æ–°åˆ›å»º channel
      setTimeout(() => {
        const newChannel = createChannelForIframe(iframeId, iframe);
        if (iframeId === 'iframe1') {
          window.channel1 = newChannel;
        } else {
          window.channel2 = newChannel;
        }
      }, 100);
    }
    
    // æš´éœ²ç»™å…¨å±€
    window.channel1 = channel1;
    window.channel2 = channel2;
    
    log('Hub å·²å¯åŠ¨ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥...', 'info');
  </script>
</body>
</html>
