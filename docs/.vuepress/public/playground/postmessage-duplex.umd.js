!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).PostMessageChannel={})}(this,function(e){"use strict";const t="postmessage-duplex",i="1.0.0",r="undefined"!=typeof window?window:"undefined"!=typeof self?self:{};var s,n;r.__POSTMESSAGE_DUPLEX__||(r.__POSTMESSAGE_DUPLEX__={}),r.__POSTMESSAGE_DUPLEX__.version=i,r.__POSTMESSAGE_DUPLEX__.name=t,e.ReturnCode=void 0,(s=e.ReturnCode||(e.ReturnCode={}))[s.Success=0]="Success",s[s.ReceiverCallbackError=-1]="ReceiverCallbackError",s[s.SendCallbackError=-2]="SendCallbackError",s[s.NoSubscribe=-3]="NoSubscribe",s[s.TimeOut=-99]="TimeOut",e.ErrorCode=void 0,(n=e.ErrorCode||(e.ErrorCode={})).ConnectionDestroyed="CONNECTION_DESTROYED",n.ConnectionTimeout="CONNECTION_TIMEOUT",n.MethodCallTimeout="METHOD_CALL_TIMEOUT",n.MethodNotFound="METHOD_NOT_FOUND",n.TransmissionFailed="TRANSMISSION_FAILED",n.MessageSizeExceeded="MESSAGE_SIZE_EXCEEDED",n.RateLimitExceeded="RATE_LIMIT_EXCEEDED",n.HandlerError="HANDLER_ERROR",n.InvalidMessage="INVALID_MESSAGE",n.OriginMismatch="ORIGIN_MISMATCH";class a extends Error{constructor(e,t,i){super(e),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"details",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="ChannelError",this.code=t,this.details=i,Error.captureStackTrace&&Error.captureStackTrace(this,a)}toJSON(){return{name:this.name,message:this.message,code:this.code,details:this.details,stack:this.stack}}}class o{constructor(){Object.defineProperty(this,"timeouts",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"timer",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"nextDeadline",{enumerable:!0,configurable:!0,writable:!0,value:1/0}),Object.defineProperty(this,"destroyed",{enumerable:!0,configurable:!0,writable:!0,value:!1})}add(e,t,i){if(this.destroyed)return;const r=Date.now()+t;this.timeouts.set(e,{deadline:r,callback:i}),r<this.nextDeadline&&this.reschedule(r)}remove(e){return this.timeouts.delete(e)}has(e){return this.timeouts.has(e)}get size(){return this.timeouts.size}reschedule(e){null!==this.timer&&clearTimeout(this.timer),this.nextDeadline=e;const t=Math.max(0,e-Date.now());this.timer=setTimeout(()=>this.processTimeouts(),t)}processTimeouts(){if(this.destroyed)return;const e=Date.now(),t=[];for(const[i,{deadline:r,callback:s}]of this.timeouts)r<=e&&(t.push(s),this.timeouts.delete(i));for(const e of t)try{e()}catch(e){console.error("[TimeoutManager] Callback error:",e)}this.scheduleNext()}scheduleNext(){if(0===this.timeouts.size)return this.nextDeadline=1/0,void(this.timer=null);let e=1/0;for(const{deadline:t}of this.timeouts.values())t<e&&(e=t);e<1/0&&this.reschedule(e)}destroy(){this.destroyed=!0,null!==this.timer&&(clearTimeout(this.timer),this.timer=null),this.timeouts.clear(),this.nextDeadline=1/0}clear(){null!==this.timer&&(clearTimeout(this.timer),this.timer=null),this.timeouts.clear(),this.nextDeadline=1/0}}class l{constructor(e,t=1e3){Object.defineProperty(this,"limit",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"windowMs",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"timestamps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"head",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"tail",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"count",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"enabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.enabled=e>0,this.timestamps=this.enabled?new Array(e).fill(0):[]}tryAcquire(){if(!this.enabled)return!0;const e=Date.now(),t=e-this.windowMs;for(;this.count>0&&this.timestamps[this.head]<=t;)this.head=(this.head+1)%this.limit,this.count--;return!(this.count>=this.limit||(this.timestamps[this.tail]=e,this.tail=(this.tail+1)%this.limit,this.count++,0))}getCurrentCount(){if(!this.enabled)return 0;const e=Date.now()-this.windowMs;let t=0,i=this.head;for(let r=0;r<this.count;r++)this.timestamps[i]>e&&t++,i=(i+1)%this.limit;return t}getRemainingCapacity(){return this.enabled?Math.max(0,this.limit-this.getCurrentCount()):1/0}getTimeUntilAvailable(){if(!this.enabled||this.count<this.limit)return 0;const e=Date.now()-this.windowMs;let t=this.head;for(;t!==this.tail;){if(this.timestamps[t]>e)return this.timestamps[t]-e;t=(t+1)%this.limit}return 0}isLimited(){return!!this.enabled&&this.getCurrentCount()>=this.limit}reset(){this.head=0,this.tail=0,this.count=0,this.enabled&&this.timestamps.fill(0)}getLimit(){return this.limit}getWindowMs(){return this.windowMs}isEnabled(){return this.enabled}}class d{constructor(){Object.defineProperty(this,"eventHandlers",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"eventsEnabled",{enumerable:!0,configurable:!0,writable:!0,value:!0})}on(e,t){let i=this.eventHandlers.get(e);return i||(i=new Set,this.eventHandlers.set(e,i)),i.add(t),()=>{i?.delete(t),0===i?.size&&this.eventHandlers.delete(e)}}once(e,t){const i=r=>{this.off(e,i),t(r)};return this.on(e,i)}off(e,t){const i=this.eventHandlers.get(e);if(!i)return!1;const r=i.delete(t);return 0===i.size&&this.eventHandlers.delete(e),r}offAll(e){e?this.eventHandlers.delete(e):this.eventHandlers.clear()}emit(e,t){if(!this.eventsEnabled)return;const i=this.eventHandlers.get(e);if(i)for(const r of[...i])try{r(t)}catch(t){console.error(`[ChannelEventEmitter] Error in ${e} handler:`,t)}}hasListeners(e){const t=this.eventHandlers.get(e);return void 0!==t&&t.size>0}listenerCount(e){return this.eventHandlers.get(e)?.size??0}setEventsEnabled(e){this.eventsEnabled=e}destroyEventEmitter(){this.eventHandlers.clear(),this.eventsEnabled=!1}}function c(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function u(e){return"string"==typeof e&&e.length>0}function h(t){if(!c(t))return{valid:!1,error:"Message must be an object"};const i=t,r="requestId"in i,s="cmdname"in i,n="msg"in i,a="ret"in i;return r||s||n?r&&"string"!=typeof i.requestId?{valid:!1,error:"requestId must be a string"}:s&&"string"!=typeof i.cmdname?{valid:!1,error:"cmdname must be a string"}:n&&"string"!=typeof i.msg?{valid:!1,error:"msg must be a string"}:!a||"number"==typeof(o=i.ret)&&Object.values(e.ReturnCode).includes(o)?"data"in i&&void 0!==i.data&&!c(i.data)?{valid:!1,error:"data must be an object"}:"_senderKey"in i&&void 0!==i._senderKey&&"string"!=typeof i._senderKey?{valid:!1,error:"_senderKey must be a string"}:!("time"in i)||void 0===i.time||"number"==typeof i.time&&Number.isFinite(i.time)?{valid:!0,message:i}:{valid:!1,error:"time must be a finite number"}:{valid:!1,error:"ret must be a valid ReturnCode"}:{valid:!1,error:"Message must have requestId, cmdname, or msg field"};var o}function g(e){return"ret"in e&&"number"==typeof e.ret}function m(e){return"ready"===e.msg}function b(e){try{const t=JSON.stringify(e);return"undefined"!=typeof Blob?new Blob([t]).size:2*t.length}catch{return 1/0}}const f="undefined"!=typeof window?window:"undefined"!=typeof self?self:{},p=[],y=[],v={totalSent:0,totalReceived:0,timeouts:0,errors:0,activeChannels:0};let w=!1;function S(e){y.length>=200&&y.shift(),y.push(e)}function M(e,t){for(let i=y.length-1;i>=0;i--)if(y[i].requestId===e&&"pending"===y[i].status){y[i].status=t,y[i].duration=Date.now()-y[i].timestamp;break}}function E(){const e=new Date;return`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}:${String(e.getSeconds()).padStart(2,"0")}.${String(e.getMilliseconds()).padStart(3,"0")}`}function C(e,t,i,r=!1){const s=E(),n="send"===e?"üì§":"üì•",a="send"===e?"‚Üí":"‚Üê",o=r?" (response)":"";console.log(`%c[${s}] ${n} ${a} ${t||i}${o}`,`color: ${"send"===e?"#2196F3":"#4CAF50"}; font-weight: bold`)}class O{help(){console.log(`\n%c‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n‚ïë           PostMessage Channel Debugger v${i.padEnd(10)}          ‚ïë\n‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n‚ïë  Available Commands:                                         ‚ïë\n‚ïë                                                              ‚ïë\n‚ïë  debug.help()              - Show this help message          ‚ïë\n‚ïë  debug.getChannels()       - List all active channels        ‚ïë\n‚ïë  debug.getHistory(opts?)   - View message history            ‚ïë\n‚ïë  debug.enableLiveLog(bool) - Toggle real-time logging        ‚ïë\n‚ïë  debug.getPending()        - List pending requests           ‚ïë\n‚ïë  debug.getStats()          - Show statistics                 ‚ïë\n‚ïë  debug.exportReport()      - Export debug report as JSON     ‚ïë\n‚ïë  debug.clear()             - Clear history and stats         ‚ïë\n‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`,"color: #2196F3; font-family: monospace")}getChannels(){const e=[],t=[];for(const i of p){const r=i.deref();if(r){t.push(i);const s={type:r.channelType||"unknown",isReady:r.isReady,isDestroyed:r.isDestroyed||!1,baseKey:r.baseKey||"",peerKey:r.getPeerKey(),pendingCount:r.getPendingCount(),subscriptions:Array.from(r.subscribeMap?.keys()||[])};"function"==typeof r.getTargetOrigin&&(s.targetOrigin=r.getTargetOrigin()),e.push(s)}}return p.length=0,p.push(...t),v.activeChannels=t.length,0===e.length?console.log("%cNo active channels found.","color: #999"):e.forEach((e,t)=>{const i=e.isDestroyed?"üíÄ":e.isReady?"‚úì":"‚è≥",r=e.isDestroyed?"#999":e.isReady?"#4CAF50":"#FF9800";console.log(`\n%cChannel #${t+1} (${e.type})\n%c‚îú‚îÄ Status: ${i} ${e.isDestroyed?"Destroyed":e.isReady?"Ready":"Connecting"}\n‚îú‚îÄ BaseKey: ${e.baseKey}\n‚îú‚îÄ PeerKey: ${e.peerKey||"(not paired)"}\n‚îú‚îÄ Pending: ${e.pendingCount} requests\n‚îú‚îÄ Subscriptions: ${e.subscriptions.join(", ")||"(none)"}\n${e.targetOrigin?`‚îî‚îÄ Target: ${e.targetOrigin}`:"‚îî‚îÄ (no target info)"}`,"color: #2196F3; font-weight: bold",`color: ${r}`)}),e}getHistory(e){let t=[...y];if(e?.filter){const i=e.filter.toLowerCase();t=t.filter(e=>e.cmdname.toLowerCase().includes(i)||e.requestId.toLowerCase().includes(i))}if(e?.limit&&e.limit>0&&(t=t.slice(-e.limit)),0===t.length)console.log("%cNo message history.","color: #999");else{const e=t.map(e=>({Dir:"send"===e.direction?"‚Üí":"‚Üê",Command:e.cmdname||e.requestId.slice(-8),Status:"ok"===e.status?"‚úì":"timeout"===e.status?"‚è±":"error"===e.status?"‚úó":"...",Time:void 0!==e.duration?`${e.duration}ms`:"-",Timestamp:new Date(e.timestamp).toLocaleTimeString("en-US",{hour12:!1})}));console.table(e)}return t}enableLiveLog(e){w=e,e?console.log("%cüî¥ Live logging ENABLED. Messages will appear in real-time.","color: #4CAF50; font-weight: bold"):console.log("%c‚ö™ Live logging DISABLED.","color: #999")}getPending(){const e=[];return p.forEach((t,i)=>{const r=t.deref();if(r){const t=r.requestCmdMap;if(t)for(const[r,s]of t)e.push({channelIndex:i,requestId:r,cmdname:s})}}),0===e.length?console.log("%cNo pending requests.","color: #999"):console.table(e),e}getStats(){return console.log(`\n%c‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n‚ïë     PostMessage Channel Statistics   ‚ïë\n‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n‚ïë  üì§ Total Sent:      ${String(v.totalSent).padStart(10)}     ‚ïë\n‚ïë  üì• Total Received:  ${String(v.totalReceived).padStart(10)}     ‚ïë\n‚ïë  ‚è±  Timeouts:        ${String(v.timeouts).padStart(10)}     ‚ïë\n‚ïë  ‚ùå Errors:          ${String(v.errors).padStart(10)}     ‚ïë\n‚ïë  üì° Active Channels: ${String(v.activeChannels).padStart(10)}     ‚ïë\n‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`,"color: #2196F3; font-family: monospace"),{...v}}exportReport(){const e={version:i,name:t,timestamp:(new Date).toISOString(),stats:{...v},channels:this.getChannels(),history:y.slice(-100),pending:this.getPending()},r=JSON.stringify(e,null,2);return console.log("%cDebug report exported. Use copy() to copy to clipboard.","color: #4CAF50"),r}clear(){y.length=0,v.totalSent=0,v.totalReceived=0,v.timeouts=0,v.errors=0,console.log("%cHistory and stats cleared.","color: #999")}isLiveLogEnabled(){return w}}let P=null;function k(e){const t=Date.now().toString(36);let i;if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(2);crypto.getRandomValues(e),i=e[0].toString(36)+e[1].toString(36)}else i=Math.floor(1e10*Math.random()).toString(36);return`${e}${t}${i}_`}class _ extends d{constructor(e){super(),Object.defineProperty(this,"baseKey",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"peerKey",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"reqTime",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"callbackMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"subscribeMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isReady",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"isDestroyed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"postTasks",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"bindOnMessage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"console",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxMessageSize",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeoutManager",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"rateLimiter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"strictValidation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"requestCmdMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),this.timeout=e?.timeout??5e3,this.console=e?.log??("undefined"!=typeof window?window.console:console),this.maxMessageSize=e?.maxMessageSize??1048576,this.strictValidation=e?.strictValidation??!0,this.timeoutManager=new o;const t=e?.rateLimit??100;if(this.rateLimiter=new l(t,1e3),e?.subscribeMap)for(const t in e.subscribeMap)this.subscribeMap.set(t,e.subscribeMap[t]);var i;this.bindOnMessage=this.onMessage.bind(this),i=this,p.push(new WeakRef(i)),v.activeChannels++,i.on("message:sent",({cmdname:e,requestId:t})=>{v.totalSent++,S({direction:"send",cmdname:e,requestId:t,status:"pending",timestamp:Date.now(),dataSummary:""}),w&&C("send",e,t)}),i.on("message:received",({cmdname:e,requestId:t,isResponse:i})=>{v.totalReceived++;const r=e||"",s=t||"";i?M(s,"ok"):S({direction:"receive",cmdname:r,requestId:s,status:"ok",timestamp:Date.now(),dataSummary:""}),w&&C("receive",r,s,i)}),i.on("timeout",({cmdname:e,requestId:t})=>{v.timeouts++,M(t,"timeout"),w&&function(e,t){const i=E();console.log(`%c[${i}] ‚è± TIMEOUT: ${e||t}`,"color: #FF9800; font-weight: bold")}(e,t)}),i.on("error",({context:e})=>{v.errors++,w&&function(e){const t=E();console.log(`%c[${t}] ‚ùå ERROR: ${e}`,"color: #F44336; font-weight: bold")}(e||"unknown")}),i.on("destroy",()=>{v.activeChannels=Math.max(0,v.activeChannels-1)})}checkRateLimit(){if(!this.rateLimiter.isEnabled())return!0;if(!this.rateLimiter.tryAcquire()){const e=this.rateLimiter.getCurrentCount(),t=this.rateLimiter.getLimit();return this.log("warn","Rate limit exceeded:",e,"/",t,"messages per second"),this.emit("rate:limited",{currentCount:e,limit:t}),!1}return!0}validateMessageSize(t){if(this.maxMessageSize<=0)return;const i=b(t);if(i>this.maxMessageSize){const t=new a(`Message size (${i} bytes) exceeds limit (${this.maxMessageSize} bytes)`,e.ErrorCode.MessageSizeExceeded,{size:i,limit:this.maxMessageSize});throw this.emit("error",{error:t,context:"validateMessageSize"}),t}}init(){this.setupMessageListener(),this.sendMessage({requestId:this.baseKey+this.reqTime,msg:"ready",_senderKey:this.baseKey})}log(e,...t){this.console?.[e]?.(`[${this.channelType}]: `,...t)}isFromPeer(e){return!(this.peerKey&&(e._senderKey&&e._senderKey!==this.peerKey?(this.log("log","Message from non-paired channel, ignored",e._senderKey,"expected:",this.peerKey),1):g(e)&&e.requestId&&!e.requestId.startsWith(this.baseKey)))}sendMessage(e,t){this.validateMessageSize(e),this.checkRateLimit()?(e.time=Date.now(),e._senderKey=this.baseKey,this.sendRawMessage(e,t)):this.log("warn","Message dropped due to rate limiting")}async onMessage(t){if(this.log("log","onMessage",t.data),!this.isValidSource(t))return;if(this.strictValidation){const e=h(t.data);if(!e.valid)return this.log("warn","Invalid message structure:",e.error),void this.emit("validation:failed",{reason:e.error,data:t.data})}const i=t.data;if(!i)return;if(!this.isFromPeer(i))return;this.emit("message:received",{cmdname:i.cmdname||"",requestId:i.requestId||"",isResponse:g(i)});const{requestId:r,cmdname:s,msg:n,_senderKey:a}=i,o=r?this.callbackMap.get(r):void 0;if(o&&r)return this.timeoutManager.remove(r),this.requestCmdMap.delete(r),o.resolve(i),void this.deleteCallback(r);if(s){const t=this.subscribeMap.get(s);if(t){try{const s=await t(i);this.sendMessage({requestId:r,ret:e.ReturnCode.Success,data:s})}catch(t){const n=t instanceof Error?t.message:String(t);this.sendMessage({req:i,requestId:r,ret:e.ReturnCode.ReceiverCallbackError,msg:n||"unknown error"}),this.emit("error",{error:t instanceof Error?t:new Error(n),context:`handler:${s}`})}return}}if(m(i))return a&&!this.peerKey&&(this.peerKey=a,this.log("log","Point-to-point pairing established","self:",this.baseKey,"peer:",this.peerKey)),this.isReady=!0,this.executePosts(),this.emit("ready",{peerKey:this.peerKey}),void(g(i)||this.sendMessage({requestId:r,ret:e.ReturnCode.Success,msg:"ready"}));r&&!g(i)&&(this.log("warn","No registered handler for:",s||r),this.sendMessage({requestId:r,ret:e.ReturnCode.NoSubscribe}))}postMessage(e,t){try{this.sendMessage(e,t);const i=e;this.emit("message:sent",{cmdname:i.cmdname||"",requestId:i.requestId||""})}catch(t){this.log("error",t,e),this.emit("error",{error:t instanceof Error?t:new Error(String(t)),context:"postMessage"})}}publish(t,i,r){if(this.isDestroyed)return Promise.reject(new a("Cannot publish: channel has been destroyed",e.ErrorCode.ConnectionDestroyed,{cmdname:t}));const s=this.baseKey+ ++this.reqTime,n={requestId:s,cmdname:t,data:i};this.requestCmdMap.set(s,t);const o=new Promise((e,t)=>{this.callbackMap.set(s,{resolve:e,reject:t})});return this.log("log","publish",this.isReady,this.postTasks.size),this.isReady?this.doPublish(n,r):this.postTasks.set(s,{data:n,prm:o,options:r}),o}doPublish(t,i){const{requestId:r,cmdname:s}=t,n=i?.timeout??this.timeout;this.timeoutManager.add(r,n,()=>{const i=this.callbackMap.get(r);if(i){const a={req:t,requestId:r,ret:e.ReturnCode.TimeOut,time:Date.now(),msg:"timeout"};this.log("error","postmessage timeout",a),this.emit("timeout",{requestId:r,cmdname:s,timeoutMs:n}),i.resolve(a),this.deleteCallback(r),this.requestCmdMap.delete(r)}}),this.postMessage(t,i?.transferables)}deleteCallback(e){this.callbackMap.delete(e),this.postTasks.delete(e),this.timeoutManager.remove(e)}executePosts(){for(const e of this.postTasks.values())this.doPublish(e.data,e.options)}call(e,t,i){return this.publish(e,t,i)}subscribe(e,t){return this.subscribeMap.has(e)&&this.log("warn",`${e} has been subscribed`),this.subscribeMap.set(e,t),this}unSubscribe(e){return this.subscribeMap.delete(e),this}subscribeOnce(e,t){return this.subscribe(e,async i=>(this.unSubscribe(e),t(i)))}getPeerKey(){return this.peerKey}getRateLimitStats(){return{current:this.rateLimiter.getCurrentCount(),limit:this.rateLimiter.getLimit(),remaining:this.rateLimiter.getRemainingCapacity()}}getPendingCount(){return this.callbackMap.size}destroy(){if(this.isDestroyed)return;this.isDestroyed=!0,this.emit("destroy",{reason:"explicit"}),function(e){const t=p.findIndex(t=>t.deref()===e);-1!==t&&p.splice(t,1)}(this);const t=new a("Channel has been destroyed",e.ErrorCode.ConnectionDestroyed);for(const[i,r]of this.callbackMap)try{r.reject({ret:e.ReturnCode.SendCallbackError,msg:t.message})}catch(e){this.log("warn","Error rejecting pending request:",i,e)}this.removeMessageListener(),this.subscribeMap.clear(),this.postTasks.clear(),this.callbackMap.clear(),this.requestCmdMap.clear(),this.timeoutManager.destroy(),this.rateLimiter.reset(),this.destroyEventEmitter(),this.isReady=!1,this.peerKey=""}}function T(e){const t=document.createElement("div");t.innerHTML="<a/>";const i=t.firstChild;return i.href=e,i}class I extends _{constructor(e,t){if(super(t),Object.defineProperty(this,"channelType",{enumerable:!0,configurable:!0,writable:!0,value:"ServiceWorkerChannel"}),Object.defineProperty(this,"isWorkerSide",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"worker",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"swContainer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.isWorkerSide=t?.isWorkerSide??!1,this.isWorkerSide){if("string"!=typeof e)throw new Error("Service Worker Á´ØÂøÖÈ°ª‰º†ÂÖ• clientId Â≠óÁ¨¶‰∏≤");this.clientId=e,this.baseKey=k("sw_")}else{if(!e||"string"==typeof e)throw new Error("È°µÈù¢Á´ØÂøÖÈ°ª‰º†ÂÖ•ÊúâÊïàÁöÑ ServiceWorker ÂÆû‰æã");this.worker=e,this.swContainer=navigator.serviceWorker,this.baseKey=k("page_")}this.log("log","baseKey",this.baseKey,this.isWorkerSide?"worker":"page"),this.init()}setupMessageListener(){this.isWorkerSide?self.addEventListener("message",this.bindOnMessage):this.swContainer?.addEventListener("message",this.bindOnMessage)}removeMessageListener(){this.isWorkerSide?self.removeEventListener("message",this.bindOnMessage):this.swContainer?.removeEventListener("message",this.bindOnMessage)}sendRawMessage(e,t){try{const i=JSON.parse(JSON.stringify(e));this.isWorkerSide?this.sendToClient(i,t):t&&t.length>0?this.worker?.postMessage(i,t):this.worker?.postMessage(i)}catch(t){this.log("error","sendMessage error",t,e)}}async sendToClient(e,t){const i=this.clientId;if(i)try{const r=await self.clients.get(i);r?t&&t.length>0?r.postMessage(e,t):r.postMessage(e):this.log("warn","Client not found:",i)}catch(e){this.log("error","sendToClient error",e)}else this.log("error","No clientId available")}isValidSource(e){if(this.isWorkerSide){const t=e.source;return t?.id===this.clientId}return!0}log(e,...t){const i=this.isWorkerSide?"worker":"page";this.console?.[e]?.(`[ServiceWorkerChannel](${i}): `,...t)}getClientId(){return this.clientId}isWorkerAvailable(){return this.isWorkerSide||"activated"===this.worker?.state}static async createFromPage(e){if(!("serviceWorker"in navigator))throw new Error("Service Worker is not supported in this browser");const t=(await navigator.serviceWorker.ready).active||navigator.serviceWorker.controller;if(!t)throw new Error("No active Service Worker found");return new I(t,e)}static createFromWorker(e,t){return new I(e,{...t,isWorkerSide:!0})}static createFromEvent(e,t){const i=e.source;if(!i?.id)throw new Error("Invalid message event: no client source");return I.createFromWorker(i.id,t)}}e.BaseChannel=_,e.ChannelError=a,e.ChannelEventEmitter=d,e.IframeChannel=class extends _{constructor(e,t){if(super(t),Object.defineProperty(this,"channelType",{enumerable:!0,configurable:!0,writable:!0,value:"IframeChannel"}),Object.defineProperty(this,"isSon",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"link",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"targetOrigin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"url",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"iframe",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"string"==typeof e){this.isSon=!0,this.url=e,this.link=T(e),this.targetOrigin=this.link.origin;const t=T(document.referrer).origin;if(this.targetOrigin!==t)throw new Error(`Áà∂È°µÈù¢ ${document.referrer} ÈùûÊåáÂÆöÂüüÂêçÁöÑÈ°µÈù¢ ${e} ÔºÅ`);this.baseKey=k("son_")}else this.isSon=!1,this.iframe=e,this.url=e.src,this.link=T(this.url),this.targetOrigin=this.link.origin,this.baseKey=k("parent_");this.log("log","baseKey",this.baseKey,this.isSon),this.init()}setupMessageListener(){window.addEventListener("message",this.bindOnMessage,!0)}removeMessageListener(){window.removeEventListener("message",this.bindOnMessage,!0)}sendRawMessage(e,t){try{if(this.isSon){const i=JSON.parse(JSON.stringify(e));t&&t.length>0?parent.postMessage(i,this.targetOrigin,t):parent.postMessage(i,this.targetOrigin)}else t&&t.length>0?this.iframe.contentWindow.postMessage(e,this.targetOrigin,t):this.iframe.contentWindow.postMessage(e,this.targetOrigin)}catch(t){this.log("error",t,e,this.targetOrigin)}}isValidSource(e){return e.origin!==this.targetOrigin?(this.log("log","Êú™Â§ÑÁêÜ",e.data,e,"ÈùûÁõÆÊ†áÊ∫ê:",this.targetOrigin),!1):!(!this.isSon&&e.source!==this.iframe?.contentWindow)}log(e,...t){this.console?.[e]?.(`[${this.targetOrigin||"IframeChannel"}](${this.isSon?"son":"parent"}): `,...t)}getTargetOrigin(){return this.targetOrigin}getTargetUrl(){return this.url}},e.PKG_NAME=t,e.PKG_VERSION=i,e.ServiceWorkerChannel=I,e.SlidingWindowRateLimiter=l,e.TimeoutManager=o,e.createConnectionDestroyedError=function(t){return new a("Channel has been destroyed",e.ErrorCode.ConnectionDestroyed,t?{requestId:t}:void 0)},e.createHandlerError=function(t,i){return new a(i.message||`Handler for "${t}" threw an error`,e.ErrorCode.HandlerError,{cmdname:t,originalError:i.message,stack:i.stack})},e.createTimeoutError=function(t,i){return new a(`Request "${t}" timed out after ${i}ms`,e.ErrorCode.MethodCallTimeout,{cmdname:t,timeout:i})},e.enableDebugger=function(){return P||(P=new O),f.__POSTMESSAGE_DUPLEX__||(f.__POSTMESSAGE_DUPLEX__={}),Object.defineProperty(f.__POSTMESSAGE_DUPLEX__,"debug",{value:P,writable:!1,configurable:!0}),console.log("%cüîß PostMessage Debugger enabled. Type __POSTMESSAGE_DUPLEX__.debug.help() for commands.","color: #4CAF50; font-weight: bold"),P},e.estimateMessageSize=b,e.getDebugger=function(){return P},e.isDebuggerEnabled=function(){return null!==P&&void 0!==f.__POSTMESSAGE_DUPLEX__?.debug},e.isReadyMessage=m,e.isResponseMessage=g,e.sanitizeForLogging=function(e){const t={},i=["requestId","cmdname","ret","msg","time","_senderKey"];for(const r of i)r in e&&(t[r]=e[r]);if("data"in e&&void 0!==e.data)try{t.data=JSON.parse(JSON.stringify(e.data))}catch{t.data="[Unserializable data]"}return t},e.validateMessage=h,e.validateRequest=function(e){const t=h(e);if(!t.valid)return t;const i=t.message;return u(i.requestId)?u(i.cmdname)?t:{valid:!1,error:"Request must have a non-empty cmdname"}:{valid:!1,error:"Request must have a non-empty requestId"}},e.validateResponse=function(e){const t=h(e);return t.valid?"ret"in t.message?t:{valid:!1,error:"Response must have a ret field"}:t}});
//# sourceMappingURL=index.umd.js.map
