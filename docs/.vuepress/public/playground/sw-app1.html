<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åº”ç”¨1 - Service Worker å¤šé¡µé¢é€šè®¯</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 15px;
      min-height: 100vh;
    }
    
    .app-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    
    .app-header {
      background: #667eea;
      color: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .app-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .app-id {
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .status-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.2);
    }
    
    .status-badge.connected {
      background: rgba(76, 175, 80, 0.3);
    }
    
    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #ffeb3b;
    }
    
    .status-badge.connected .status-dot {
      background: #4caf50;
    }
    
    .app-body {
      padding: 16px;
    }
    
    .section {
      margin-bottom: 16px;
    }
    
    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: #606266;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary { background: #667eea; color: white; }
    .btn-success { background: #4caf50; color: white; }
    .btn-warning { background: #ff9800; color: white; }
    .btn-info { background: #2196f3; color: white; }
    
    .input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    input[type="text"] {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #dcdfe6;
      border-radius: 6px;
      font-size: 13px;
      outline: none;
    }
    
    input[type="text"]:focus {
      border-color: #667eea;
    }
    
    .log-container {
      background: #1e1e1e;
      border-radius: 6px;
      padding: 12px;
      height: 180px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 11px;
    }
    
    .log-item {
      padding: 3px 0;
      border-bottom: 1px solid #333;
      line-height: 1.4;
    }
    
    .log-item:last-child {
      border-bottom: none;
    }
    
    .log-time { color: #888; }
    .log-send { color: #4ec9b0; }
    .log-receive { color: #dcdcaa; }
    .log-error { color: #f48771; }
    .log-info { color: #9cdcfe; }
    .log-broadcast { color: #c586c0; }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .stat-card {
      background: #f5f7fa;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
    }
    
    .stat-label {
      font-size: 11px;
      color: #909399;
      margin-top: 4px;
    }
    
    .client-id {
      font-size: 11px;
      color: #909399;
      word-break: break-all;
      margin-top: 8px;
      padding: 8px;
      background: #f5f7fa;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="app-header">
      <div class="app-title">
        <span>åº”ç”¨ 1</span>
        <span class="app-id">è´­ç‰©è½¦æ¨¡å—</span>
      </div>
      <div class="status-badge" id="status">
        <span class="status-dot"></span>
        <span>æœªè¿æ¥</span>
      </div>
    </div>
    
    <div class="app-body">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="msgSent">0</div>
          <div class="stat-label">å‘é€æ¶ˆæ¯</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="msgReceived">0</div>
          <div class="stat-label">æ¥æ”¶æ¶ˆæ¯</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="latency">-</div>
          <div class="stat-label">å»¶è¿Ÿ(ms)</div>
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">è¿æ¥ç®¡ç†</div>
        <div class="controls">
          <button class="btn-primary" id="btnConnect">è¿æ¥ SW</button>
          <button class="btn-warning" id="btnDisconnect" disabled>æ–­å¼€</button>
        </div>
        <div class="client-id" id="clientId">Client ID: ç­‰å¾…è¿æ¥...</div>
      </div>
      
      <div class="section">
        <div class="section-title">ç‚¹å¯¹ç‚¹é€šè®¯ï¼ˆè¯·æ±‚-å“åº”ï¼‰</div>
        <div class="input-group">
          <input type="text" id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹" value="æ¥è‡ªåº”ç”¨1çš„æ¶ˆæ¯">
          <button class="btn-success" id="btnSend" disabled>å‘é€(ç‚¹å¯¹ç‚¹)</button>
        </div>
        <div class="controls">
          <button class="btn-info" id="btnPing" disabled>Ping</button>
          <button class="btn-primary" id="btnGetCart" disabled>è·å–è´­ç‰©è½¦</button>
          <button class="btn-primary" id="btnUpdateCart" disabled>æ›´æ–°è´­ç‰©è½¦</button>
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">å¹¿æ’­é€šè®¯ï¼ˆå•å‘æ— å“åº”ï¼‰</div>
        <div class="controls">
          <button class="btn-warning" id="btnBroadcast" disabled>å¹¿æ’­ç»™æ‰€æœ‰</button>
          <button class="btn-warning" id="btnBroadcastToUser" disabled>å¹¿æ’­ç»™ç”¨æˆ·ä¸­å¿ƒ</button>
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">
          é€šè®¯æ—¥å¿—
          <button onclick="clearLog()" style="float: right; padding: 2px 8px; font-size: 10px; background: #909399; color: white; border: none; border-radius: 3px; cursor: pointer;">æ¸…ç©º</button>
        </div>
        <div class="log-container" id="logContainer"></div>
      </div>
    </div>
  </div>

  <script src="./postmessage-duplex.umd.js"></script>
  <script>
    const { ServiceWorkerChannel, ReturnCode } = PostMessageChannel;
    
    const APP_NAME = 'åº”ç”¨1';
    const APP_COLOR = '#667eea';
    
    // DOM elements
    const logContainer = document.getElementById('logContainer');
    const statusEl = document.getElementById('status');
    const clientIdEl = document.getElementById('clientId');
    const msgSentEl = document.getElementById('msgSent');
    const msgReceivedEl = document.getElementById('msgReceived');
    const latencyEl = document.getElementById('latency');
    
    const btnConnect = document.getElementById('btnConnect');
    const btnDisconnect = document.getElementById('btnDisconnect');
    const btnSend = document.getElementById('btnSend');
    const btnPing = document.getElementById('btnPing');
    const btnGetCart = document.getElementById('btnGetCart');
    const btnUpdateCart = document.getElementById('btnUpdateCart');
    const btnBroadcast = document.getElementById('btnBroadcast');
    const btnBroadcastToUser = document.getElementById('btnBroadcastToUser');
    const msgInput = document.getElementById('msgInput');
    
    let channel = null;
    let stats = { sent: 0, received: 0 };
    
    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const item = document.createElement('div');
      item.className = 'log-item';
      item.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
      logContainer.appendChild(item);
      logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    function clearLog() {
      logContainer.innerHTML = '';
      log('æ—¥å¿—å·²æ¸…ç©º', 'info');
    }
    
    function updateStats() {
      msgSentEl.textContent = stats.sent;
      msgReceivedEl.textContent = stats.received;
    }
    
    function updateStatus(connected, clientId = null) {
      if (connected) {
        statusEl.className = 'status-badge connected';
        statusEl.innerHTML = '<span class="status-dot"></span><span>å·²è¿æ¥</span>';
        clientIdEl.textContent = 'Client ID: ' + (clientId || 'å·²è¿æ¥');
      } else {
        statusEl.className = 'status-badge';
        statusEl.innerHTML = '<span class="status-dot"></span><span>æœªè¿æ¥</span>';
        clientIdEl.textContent = 'Client ID: ç­‰å¾…è¿æ¥...';
      }
    }
    
    function setButtonsEnabled(enabled) {
      btnSend.disabled = !enabled;
      btnPing.disabled = !enabled;
      btnGetCart.disabled = !enabled;
      btnUpdateCart.disabled = !enabled;
      btnBroadcast.disabled = !enabled;
      btnBroadcastToUser.disabled = !enabled;
      btnDisconnect.disabled = !enabled;
      btnConnect.disabled = enabled;
    }
    
    // æ¸…ç†å†²çªçš„ Service Workerï¼ˆå¦‚æœå­˜åœ¨å…¶ä»– SWï¼‰
    const SW_URL = './sw-multi.js';
    
    async function clearConflictingSW() {
      if (!('serviceWorker' in navigator)) return;
      
      const reg = await navigator.serviceWorker.getRegistration();
      if (reg && reg.active) {
        const currentSW = reg.active.scriptURL;
        if (!currentSW.endsWith('sw-multi.js')) {
          log('æ£€æµ‹åˆ°å…¶ä»– SW: ' + currentSW.split('/').pop() + 'ï¼Œæ­£åœ¨åˆ‡æ¢...', 'info');
          await reg.unregister();
        }
      }
    }
    
    // è¿æ¥å‡½æ•° - æŠ½å–ä¸ºç‹¬ç«‹å‡½æ•°ä»¥æ”¯æŒè‡ªåŠ¨è¿æ¥
    async function connect() {
      if (channel) return; // å·²è¿æ¥
      
      try {
        log('æ­£åœ¨è¿æ¥...', 'info');
        
        // æ¸…ç†å¯èƒ½å†²çªçš„ SW
        await clearConflictingSW();
        
        // ä½¿ç”¨ swUrl è‡ªåŠ¨æ³¨å†Œ SWï¼ŒappType/appName è‡ªåŠ¨æ³¨å†Œåˆ° Hub
        channel = await ServiceWorkerChannel.createFromPage({
          swUrl: SW_URL,         // è‡ªåŠ¨æ³¨å†Œ SW
          timeout: 5000,
          appType: 'cart',
          appName: APP_NAME,
          autoReconnect: true    // é»˜è®¤ true
        });
        
        // ç­‰å¾… ready åè·å– client ID
        const pingResponse = await channel.publish('ping');
        if (pingResponse.ret === ReturnCode.Success) {
          const clientId = pingResponse.data.clientId || 'unknown';
          updateStatus(true, clientId.slice(0, 8));
          setButtonsEnabled(true);
          log(`è¿æ¥æˆåŠŸï¼Client ID: ${clientId.slice(0, 8)}, æ´»è·ƒå®¢æˆ·ç«¯: ${pingResponse.data.activeClients}`, 'info');
          
          // ========== æ³¨å†Œå¹¿æ’­å¤„ç†å™¨ ==========
          
          // å…¨å±€å¹¿æ’­æ¶ˆæ¯
          channel.onBroadcast('globalBroadcast', ({ data }) => {
            stats.received++;
            updateStats();
            log(`ğŸ“¢ [å¹¿æ’­] æ¥è‡ª ${data.from}: ${data.message}`, 'broadcast');
          });
          
          // ç±»å‹åŒ–é€šçŸ¥å¹¿æ’­
          channel.onBroadcast('typedNotification', ({ data }) => {
            stats.received++;
            updateStats();
            log(`ğŸ”” [ç±»å‹é€šçŸ¥] ${data.title}: ${data.body} (ç›®æ ‡: ${data.targetType})`, 'broadcast');
          });
          
          // ç›‘å¬ SW æ›´æ–°äº‹ä»¶ï¼ˆç”¨äº UI æç¤ºï¼‰
          channel.on('sw-activated', ({ version }) => {
            log(`â„¹ï¸ Service Worker å·²æ›´æ–°åˆ° v${version}ï¼Œè‡ªåŠ¨é‡æ–°æ³¨å†Œä¸­...`, 'info');
          });
          
          // ========== ç‚¹å¯¹ç‚¹æ¶ˆæ¯å¤„ç†å™¨ ==========
          
          channel.subscribe('directMessage', ({ data }) => {
            stats.received++;
            updateStats();
            log(`ğŸ’¬ [ç‚¹å¯¹ç‚¹] æ¥è‡ª ${data.from}: ${data.message}`, 'receive');
            return { received: true, receivedAt: Date.now() };
          });
          
        } else {
          throw new Error(pingResponse.msg || 'è¿æ¥å¤±è´¥');
        }
      } catch (err) {
        log('è¿æ¥å¤±è´¥: ' + err.message, 'error');
        updateStatus(false);
      }
    }
    
    // è¿æ¥æŒ‰é’®äº‹ä»¶ï¼ˆä¿ç•™ç”¨äºæ‰‹åŠ¨é‡è¿ï¼‰
    btnConnect.addEventListener('click', connect);
    
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
    connect();
    
    // æ–­å¼€
    btnDisconnect.addEventListener('click', () => {
      if (channel) {
        channel.destroy();
        channel = null;
      }
      updateStatus(false);
      setButtonsEnabled(false);
      log('å·²æ–­å¼€è¿æ¥', 'info');
    });
    
    // å‘é€æ¶ˆæ¯
    btnSend.addEventListener('click', async () => {
      const message = msgInput.value.trim();
      if (!message) return;
      
      stats.sent++;
      updateStats();
      log(`ğŸ“¤ å‘é€æ¶ˆæ¯: ${message}`, 'send');
      
      const response = await channel.publish('echo', {
        message: message,
        from: APP_NAME
      });
      
      if (response.ret === ReturnCode.Success) {
        stats.received++;
        updateStats();
        log(`ğŸ“¥ å›å¤: ${response.data.echoed}`, 'receive');
      } else {
        log(`âš ï¸ å‘é€å¤±è´¥: ${response.msg}`, 'error');
      }
    });
    
    // Ping
    btnPing.addEventListener('click', async () => {
      const start = Date.now();
      stats.sent++;
      updateStats();
      log('ğŸ“¤ Ping...', 'send');
      
      const response = await channel.publish('ping');
      const latency = Date.now() - start;
      
      if (response.ret === ReturnCode.Success) {
        stats.received++;
        updateStats();
        latencyEl.textContent = latency;
        log(`ğŸ“¥ Pong! å»¶è¿Ÿ: ${latency}ms`, 'receive');
      } else {
        log(`âš ï¸ Ping å¤±è´¥: ${response.msg}`, 'error');
      }
    });
    
    // è·å–è´­ç‰©è½¦
    btnGetCart.addEventListener('click', async () => {
      stats.sent++;
      updateStats();
      log('ğŸ“¤ è·å–è´­ç‰©è½¦æ•°æ®...', 'send');
      
      const response = await channel.publish('getCart', { userId: 'user_001' });
      
      if (response.ret === ReturnCode.Success) {
        stats.received++;
        updateStats();
        const cart = response.data;
        log(`ğŸ“¥ è´­ç‰©è½¦: ${cart.items.length} ä»¶å•†å“ï¼Œæ€»ä»· Â¥${cart.total}`, 'receive');
        cart.items.forEach(item => {
          log(`   - ${item.name} x${item.quantity} Â¥${item.price}`, 'receive');
        });
      } else {
        log(`âš ï¸ è·å–å¤±è´¥: ${response.msg}`, 'error');
      }
    });
    
    // æ›´æ–°è´­ç‰©è½¦å¹¶é€šçŸ¥ï¼ˆè§¦å‘è´­ç‰©è½¦æ›´æ–°å¹¿æ’­ï¼‰
    btnUpdateCart.addEventListener('click', async () => {
      stats.sent++;
      updateStats();
      log('ğŸ“¤ æ›´æ–°è´­ç‰©è½¦å¹¶é€šçŸ¥å…¶ä»–åº”ç”¨...', 'send');
      
      const response = await channel.publish('updateCartAndNotify', {
        items: [
          { id: 1, name: 'æ–°å•†å“', price: 999 }
        ],
        total: 999
      });
      
      if (response.ret === ReturnCode.Success) {
        log(`ğŸ“¥ è´­ç‰©è½¦å·²æ›´æ–°ï¼Œå·²å¹¿æ’­ç»™ç”¨æˆ·ä¸­å¿ƒ`, 'receive');
      } else {
        log(`âš ï¸ æ›´æ–°å¤±è´¥: ${response.msg}`, 'error');
      }
    });
    
    // å¹¿æ’­æ¶ˆæ¯ï¼ˆå‘é€ç»™æ‰€æœ‰å®¢æˆ·ç«¯ï¼‰
    btnBroadcast.addEventListener('click', async () => {
      const message = msgInput.value.trim() || 'æ¥è‡ªåº”ç”¨1çš„å¹¿æ’­';
      stats.sent++;
      updateStats();
      log(`ğŸ“¤ å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯: ${message}`, 'send');
      
      // é€šè¿‡ SW è½¬å‘å¹¿æ’­ï¼ˆå› ä¸ºé¡µé¢æ— æ³•ç›´æ¥å¹¿æ’­ç»™å…¶ä»–é¡µé¢ï¼‰
      const response = await channel.publish('broadcastToAll', {
        message: message,
        from: APP_NAME
      });
      
      if (response.ret === ReturnCode.Success) {
        log(`âœ… å¹¿æ’­å·²å‘é€ç»™ ${response.data.clientCount} ä¸ªå®¢æˆ·ç«¯`, 'info');
      } else {
        log(`âš ï¸ å¹¿æ’­å¤±è´¥: ${response.msg}`, 'error');
      }
    });
    
    // å¹¿æ’­ç»™ç”¨æˆ·ä¸­å¿ƒï¼ˆæŒ‰ç±»å‹ç­›é€‰ï¼‰
    btnBroadcastToUser.addEventListener('click', async () => {
      stats.sent++;
      updateStats();
      log('ğŸ“¤ å¹¿æ’­é€šçŸ¥ç»™ç”¨æˆ·ä¸­å¿ƒ...', 'send');
      
      const response = await channel.publish('broadcastToType', {
        targetType: 'user',
        eventName: 'typedNotification',
        title: 'è´­ç‰©è½¦æ¶ˆæ¯',
        body: 'æ‚¨æœ‰æ–°çš„è´­ç‰©è½¦æ›´æ–°',
        from: APP_NAME
      });
      
      if (response.ret === ReturnCode.Success) {
        if (response.data.sentCount > 0) {
          log(`âœ… å·²å¹¿æ’­ç»™ ${response.data.sentCount} ä¸ªç”¨æˆ·ä¸­å¿ƒåº”ç”¨`, 'info');
        } else {
          log(`âš ï¸ æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·ä¸­å¿ƒåº”ç”¨ (å¯èƒ½æ­£åœ¨é‡æ–°è¿æ¥)`, 'info');
        }
      } else {
        log(`âš ï¸ å¹¿æ’­å¤±è´¥: ${response.msg}`, 'error');
      }
    });
    
    // é¡µé¢åŠ è½½å®Œæˆ
    log(`${APP_NAME} å·²åŠ è½½ï¼Œç‚¹å‡»"è¿æ¥ SW"å¼€å§‹`, 'info');
    log('æç¤º: ç‚¹å¯¹ç‚¹é€šè®¯ä½¿ç”¨ publish/subscribeï¼Œå¹¿æ’­ä½¿ç”¨ broadcast/onBroadcast', 'info');
  </script>
</body>
</html>
