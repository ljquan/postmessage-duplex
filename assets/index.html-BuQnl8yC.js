import{_ as i,c as l,a as c,b as a,d as t,w as p,e as s,r as d,o}from"./app-BZDL3wne.js";const r={};function u(m,n){const e=d("RouteLink");return o(),l("div",null,[n[6]||(n[6]=c(`<h1 id="介绍" tabindex="-1"><a class="header-anchor" href="#介绍"><span>介绍</span></a></h1><p>postmessage-duplex 是一个基于 postMessage API 的轻量级双工通讯库，支持 iframe 和 Service Worker 两种通讯场景。</p><h2 id="什么是双工通讯" tabindex="-1"><a class="header-anchor" href="#什么是双工通讯"><span>什么是双工通讯？</span></a></h2><p>双工通讯意味着两端都可以主动发起请求，并等待对方响应。就像打电话一样，双方都可以说话和倾听。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">┌─────────────────────────────────────────────────────────────┐</span>
<span class="line">│  父页面                                                       │</span>
<span class="line">│  ┌─────────────────────────────────────────────────────┐    │</span>
<span class="line">│  │  channel.publish(&#39;getData&#39;, {id: 1})  ──────────────│────│───┐</span>
<span class="line">│  │  channel.subscribe(&#39;notify&#39;, handler) &lt;─────────────│────│───│─┐</span>
<span class="line">│  └─────────────────────────────────────────────────────┘    │   │ │</span>
<span class="line">│                          ▲                                   │   │ │</span>
<span class="line">│                          │ iframe                           │   │ │</span>
<span class="line">│  ┌───────────────────────┴─────────────────────────────┐    │   │ │</span>
<span class="line">│  │  子页面                                              │    │   │ │</span>
<span class="line">│  │  channel.subscribe(&#39;getData&#39;, handler)  &lt;───────────│────│───┘ │</span>
<span class="line">│  │  channel.publish(&#39;notify&#39;, data)  ──────────────────│────│─────┘</span>
<span class="line">│  └─────────────────────────────────────────────────────┘    │</span>
<span class="line">└─────────────────────────────────────────────────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="核心特性" tabindex="-1"><a class="header-anchor" href="#核心特性"><span>核心特性</span></a></h2><h3 id="请求-响应模式" tabindex="-1"><a class="header-anchor" href="#请求-响应模式"><span>请求-响应模式</span></a></h3><p>原生 postMessage 是&quot;发后即忘&quot;的模式，你需要手动关联请求和响应。postmessage-duplex 自动处理这一切：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// 发送请求，返回 Promise</span></span>
<span class="line"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&#39;getUserInfo&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> userId<span class="token operator">:</span> <span class="token number">123</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 直接使用响应数据</span></span>
<span class="line"><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>name<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="自动消息队列" tabindex="-1"><a class="header-anchor" href="#自动消息队列"><span>自动消息队列</span></a></h3><p>在连接就绪之前发送的消息会自动缓存，连接成功后自动发送：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IframeChannel</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 即使 iframe 还没加载完，消息也会被缓存</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&#39;init&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> config<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 连接就绪后自动发送</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="类型安全" tabindex="-1"><a class="header-anchor" href="#类型安全"><span>类型安全</span></a></h3><p>完整的 TypeScript 支持，包括泛型：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">interface</span> <span class="token class-name">RemoteMethods</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">getData</span><span class="token punctuation">(</span>params<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IframeChannel<span class="token operator">&lt;</span>RemoteMethods<span class="token operator">&gt;</span></span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 自动类型推断</span></span>
<span class="line"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">channel</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;getData&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// response.data 类型为 { name: string } | undefined</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="支持的场景" tabindex="-1"><a class="header-anchor" href="#支持的场景"><span>支持的场景</span></a></h2><h3 id="iframe-通讯" tabindex="-1"><a class="header-anchor" href="#iframe-通讯"><span>Iframe 通讯</span></a></h3><p>父页面与 iframe 子页面之间的通讯，支持同域和跨域：</p><ul><li>父页面 → 子页面</li><li>子页面 → 父页面</li><li>双向同时通讯</li></ul><h3 id="service-worker-通讯" tabindex="-1"><a class="header-anchor" href="#service-worker-通讯"><span>Service Worker 通讯</span></a></h3><p>页面与 Service Worker 之间的通讯：</p><ul><li>页面 → Service Worker</li><li>Service Worker → 页面</li><li>多页面共享同一个 Service Worker</li></ul><h2 id="浏览器兼容性" tabindex="-1"><a class="header-anchor" href="#浏览器兼容性"><span>浏览器兼容性</span></a></h2><table><thead><tr><th>浏览器</th><th>Iframe</th><th>Service Worker</th></tr></thead><tbody><tr><td>Chrome</td><td>✅ 4+</td><td>✅ 40+</td></tr><tr><td>Firefox</td><td>✅ 3+</td><td>✅ 44+</td></tr><tr><td>Safari</td><td>✅ 4+</td><td>✅ 11.1+</td></tr><tr><td>Edge</td><td>✅ 12+</td><td>✅ 17+</td></tr><tr><td>IE</td><td>✅ 8+</td><td>❌</td></tr></tbody></table><h2 id="与其他库的对比" tabindex="-1"><a class="header-anchor" href="#与其他库的对比"><span>与其他库的对比</span></a></h2><table><thead><tr><th>特性</th><th>Comlink</th><th>Penpal</th><th>post-robot</th><th>postmessage-duplex</th></tr></thead><tbody><tr><td>包大小</td><td>1.1KB</td><td>~5KB</td><td>~15KB</td><td>~8KB</td></tr><tr><td>TypeScript 泛型</td><td>✅</td><td>✅</td><td>❌</td><td>✅</td></tr><tr><td>单次调用超时</td><td>❌</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>Service Worker</td><td>✅</td><td>❌</td><td>❌</td><td>✅</td></tr><tr><td>调试日志</td><td>❌</td><td>✅</td><td>❌</td><td>✅</td></tr></tbody></table><h2 id="下一步" tabindex="-1"><a class="header-anchor" href="#下一步"><span>下一步</span></a></h2>`,27)),a("ul",null,[a("li",null,[t(e,{to:"/guide/getting-started.html"},{default:p(()=>[...n[0]||(n[0]=[s("快速开始",-1)])]),_:1}),n[1]||(n[1]=s(" - 5 分钟上手",-1))]),a("li",null,[t(e,{to:"/guide/iframe-communication.html"},{default:p(()=>[...n[2]||(n[2]=[s("Iframe 通讯",-1)])]),_:1}),n[3]||(n[3]=s(" - 详细的 iframe 使用指南",-1))]),a("li",null,[t(e,{to:"/guide/service-worker.html"},{default:p(()=>[...n[4]||(n[4]=[s("Service Worker",-1)])]),_:1}),n[5]||(n[5]=s(" - SW 通讯指南",-1))])])])}const k=i(r,[["render",u]]),v=JSON.parse('{"path":"/guide/","title":"介绍","lang":"zh-CN","frontmatter":{},"git":{"updatedTime":1769419490000,"contributors":[{"name":"liquidliang","username":"liquidliang","email":"ljquan@qq.com","commits":2,"url":"https://github.com/liquidliang"}],"changelog":[{"hash":"20f9a03cf8dee9df34a1e82ca0f0f4eba97d2a60","time":1769419490000,"email":"ljquan@qq.com","author":"liquidliang","message":"chore: optimize bundle size and simplify code"},{"hash":"288e378422593e39667c397bec9bbbf25465b67a","time":1769418463000,"email":"ljquan@qq.com","author":"liquidliang","message":"init"}]},"filePathRelative":"guide/README.md"}');export{k as comp,v as data};
