import{_ as s,c as a,a as p,o as e}from"./app-BZDL3wne.js";const t={};function l(c,n){return e(),a("div",null,[...n[0]||(n[0]=[p(`<h1 id="常见问题" tabindex="-1"><a class="header-anchor" href="#常见问题"><span>常见问题</span></a></h1><h2 id="基础问题" tabindex="-1"><a class="header-anchor" href="#基础问题"><span>基础问题</span></a></h2><h3 id="q-子页面刷新后连接会断开吗" tabindex="-1"><a class="header-anchor" href="#q-子页面刷新后连接会断开吗"><span>Q: 子页面刷新后连接会断开吗？</span></a></h3><p><strong>A:</strong> 不会。通道会自动处理子页面的重新加载。父页面的通道实例会保持有效，当子页面重新加载并创建新的通道后，通讯会自动恢复。</p><h3 id="q-可以同时与多个-iframe-通讯吗" tabindex="-1"><a class="header-anchor" href="#q-可以同时与多个-iframe-通讯吗"><span>Q: 可以同时与多个 iframe 通讯吗？</span></a></h3><p><strong>A:</strong> 可以。为每个 iframe 创建独立的 <code>IframeChannel</code> 实例即可：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">const</span> channel1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IframeChannel</span><span class="token punctuation">(</span>iframe1<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> channel2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IframeChannel</span><span class="token punctuation">(</span>iframe2<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 各通道独立工作，消息不会混淆</span></span>
<span class="line"><span class="token keyword">await</span> channel1<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&#39;getData&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> from<span class="token operator">:</span> <span class="token string">&#39;channel1&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">await</span> channel2<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&#39;getData&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> from<span class="token operator">:</span> <span class="token string">&#39;channel2&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q-跨域-iframe-可以通讯吗" tabindex="-1"><a class="header-anchor" href="#q-跨域-iframe-可以通讯吗"><span>Q: 跨域 iframe 可以通讯吗？</span></a></h3><p><strong>A:</strong> 可以。子页面需要正确配置父页面的 origin：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// 子页面</span></span>
<span class="line"><span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IframeChannel</span><span class="token punctuation">(</span><span class="token string">&#39;https://parent-domain.com&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>需要注意：</p><ol><li>Origin 必须完全匹配（协议 + 域名 + 端口）</li><li>确保 iframe 没有被 CSP 阻止</li></ol><h3 id="q-service-worker-端如何使用这个库" tabindex="-1"><a class="header-anchor" href="#q-service-worker-端如何使用这个库"><span>Q: Service Worker 端如何使用这个库？</span></a></h3><p><strong>A:</strong> Service Worker 环境不支持 ES modules，有几种方式：</p><ol><li><strong>使用打包工具</strong>：将库打包到 SW 代码中</li><li><strong>使用 UMD 版本</strong>：<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token function">importScripts</span><span class="token punctuation">(</span><span class="token string">&#39;/dist/index.umd.js&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> ServiceWorkerChannel <span class="token punctuation">}</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>PostMessageChannel</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><strong>简化实现</strong>：对于简单场景，可以不使用库，直接处理消息</li></ol><h2 id="错误处理" tabindex="-1"><a class="header-anchor" href="#错误处理"><span>错误处理</span></a></h2><h3 id="q-如何处理请求超时" tabindex="-1"><a class="header-anchor" href="#q-如何处理请求超时"><span>Q: 如何处理请求超时？</span></a></h3><p><strong>A:</strong></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> ReturnCode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;postmessage-duplex&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&#39;slowOperation&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>ret <span class="token operator">===</span> ReturnCode<span class="token punctuation">.</span>TimeOut<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 处理超时</span></span>
<span class="line">  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;请求超时&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 或者设置更长的超时时间</span></span>
<span class="line"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&#39;slowOperation&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  timeout<span class="token operator">:</span> <span class="token number">30000</span> <span class="token comment">// 30 秒</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q-消息发送后没有收到响应怎么办" tabindex="-1"><a class="header-anchor" href="#q-消息发送后没有收到响应怎么办"><span>Q: 消息发送后没有收到响应怎么办？</span></a></h3><p><strong>A:</strong> 检查以下几点：</p><ol><li><p><strong>对方是否订阅了该事件？</strong></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>ret <span class="token operator">===</span> ReturnCode<span class="token punctuation">.</span>NoSubscribe<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;对方未订阅此事件&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>对方的回调是否返回了值？</strong></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// 错误：没有返回值</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&#39;test&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 正确：返回响应</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&#39;test&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span> received<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>是否有异常被吞掉？</strong></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line">channel<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&#39;test&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">someOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 必须处理错误</span></span>
<span class="line">    <span class="token keyword">throw</span> error <span class="token comment">// 或 return { error: error.message }</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="q-通道销毁后发生了什么" tabindex="-1"><a class="header-anchor" href="#q-通道销毁后发生了什么"><span>Q: 通道销毁后发生了什么？</span></a></h3><p><strong>A:</strong> 调用 <code>destroy()</code> 后：</p><ol><li>所有待处理的请求会被 reject</li><li>消息监听器被移除</li><li><code>isDestroyed</code> 变为 <code>true</code></li><li>后续的 <code>publish</code> 调用会抛出错误</li></ol><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line">channel<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&#39;test&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 会抛出错误</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token keyword">instanceof</span> <span class="token class-name">ChannelError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>code<span class="token punctuation">)</span> <span class="token comment">// &#39;CONNECTION_DESTROYED&#39;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="性能问题" tabindex="-1"><a class="header-anchor" href="#性能问题"><span>性能问题</span></a></h2><h3 id="q-发送大数据时性能很差怎么办" tabindex="-1"><a class="header-anchor" href="#q-发送大数据时性能很差怎么办"><span>Q: 发送大数据时性能很差怎么办？</span></a></h3><p><strong>A:</strong> 使用 Transferable 对象：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">const</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token comment">// 1MB</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 不使用 transferable：数据会被复制</span></span>
<span class="line"><span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&#39;upload&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> buffer <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 慢</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 使用 transferable：数据会被转移（零拷贝）</span></span>
<span class="line"><span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&#39;upload&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> buffer <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  transferables<span class="token operator">:</span> <span class="token punctuation">[</span>buffer<span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 快</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 注意：传输后原 buffer 会被清空</span></span>
<span class="line"><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span>byteLength<span class="token punctuation">)</span> <span class="token comment">// 0</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q-频繁发送消息导致卡顿怎么办" tabindex="-1"><a class="header-anchor" href="#q-频繁发送消息导致卡顿怎么办"><span>Q: 频繁发送消息导致卡顿怎么办？</span></a></h3><p><strong>A:</strong></p><ol><li><strong>批量发送</strong>：合并多个小请求</li><li><strong>节流/防抖</strong>：限制发送频率</li><li><strong>使用 rate limit</strong>：<div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IframeChannel</span><span class="token punctuation">(</span>iframe<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  rateLimit<span class="token operator">:</span> <span class="token number">50</span> <span class="token comment">// 每秒最多 50 条消息</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="q-如何监控消息性能" tabindex="-1"><a class="header-anchor" href="#q-如何监控消息性能"><span>Q: 如何监控消息性能？</span></a></h3><p><strong>A:</strong></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// 使用内置调试器</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> enableDebugger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;postmessage-duplex&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">enableDebugger</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// 然后在控制台使用: __POSTMESSAGE_DUPLEX__.debug.getStats()</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 自定义监控</span></span>
<span class="line"><span class="token keyword">const</span> start <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&#39;getData&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> duration <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start</span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>duration <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">请求耗时 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>duration<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms，考虑优化</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="安全问题" tabindex="-1"><a class="header-anchor" href="#安全问题"><span>安全问题</span></a></h2><h3 id="q-如何防止消息被篡改" tabindex="-1"><a class="header-anchor" href="#q-如何防止消息被篡改"><span>Q: 如何防止消息被篡改？</span></a></h3><p><strong>A:</strong> postmessage-duplex 内置了多层验证：</p><ol><li><strong>Origin 验证</strong>：只接受预期来源的消息</li><li><strong>Source 验证</strong>：验证消息来源窗口</li><li><strong>PeerKey 验证</strong>：验证通道配对</li></ol><p>对于更高安全需求，可以：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// 添加消息签名</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&#39;sensitiveData&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> payload<span class="token punctuation">,</span> signature <span class="token punctuation">}</span> <span class="token operator">=</span> data</span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">verifySignature</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> signature<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;Invalid signature&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">processSensitiveData</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q-如何防止-xss-攻击" tabindex="-1"><a class="header-anchor" href="#q-如何防止-xss-攻击"><span>Q: 如何防止 XSS 攻击？</span></a></h3><p><strong>A:</strong></p><ol><li><strong>验证消息来源</strong>：始终检查 origin</li><li><strong>验证消息内容</strong>：不要直接执行收到的代码</li><li><strong>使用 CSP</strong>：限制可加载的内容</li></ol><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// 不要这样做</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&#39;execute&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">eval</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>code<span class="token punctuation">)</span> <span class="token comment">// 危险！</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 应该这样做</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&#39;execute&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>allowedActions<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">executeAction</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>action<span class="token punctuation">,</span> data<span class="token punctuation">.</span>params<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;Action not allowed&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="调试问题" tabindex="-1"><a class="header-anchor" href="#调试问题"><span>调试问题</span></a></h2><h3 id="q-如何查看发送和接收的消息" tabindex="-1"><a class="header-anchor" href="#q-如何查看发送和接收的消息"><span>Q: 如何查看发送和接收的消息？</span></a></h3><p><strong>A:</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 启用调试器</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> enableDebugger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;postmessage-duplex&#39;</span></span>
<span class="line"><span class="token function">enableDebugger</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 浏览器控制台</span></span>
<span class="line">__POSTMESSAGE_DUPLEX__<span class="token punctuation">.</span>debug<span class="token punctuation">.</span><span class="token function">getHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 开启实时日志</span></span>
<span class="line">__POSTMESSAGE_DUPLEX__<span class="token punctuation">.</span>debug<span class="token punctuation">.</span><span class="token function">enableLiveLog</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q-消息追踪记录太多怎么办" tabindex="-1"><a class="header-anchor" href="#q-消息追踪记录太多怎么办"><span>Q: 消息追踪记录太多怎么办？</span></a></h3><p><strong>A:</strong> 追踪记录会自动限制数量。如需自定义：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// 使用自定义日志过滤</span></span>
<span class="line"><span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IframeChannel</span><span class="token punctuation">(</span>iframe<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  log<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function-variable function">log</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldLog</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;[Channel]&#39;</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    warn<span class="token operator">:</span> <span class="token builtin">console</span><span class="token punctuation">.</span>warn<span class="token punctuation">,</span></span>
<span class="line">    error<span class="token operator">:</span> <span class="token builtin">console</span><span class="token punctuation">.</span>error</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q-如何在生产环境关闭日志" tabindex="-1"><a class="header-anchor" href="#q-如何在生产环境关闭日志"><span>Q: 如何在生产环境关闭日志？</span></a></h3><p><strong>A:</strong></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IframeChannel</span><span class="token punctuation">(</span>iframe<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  log<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;production&#39;</span> <span class="token operator">?</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function-variable function">log</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function-variable function">warn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reportError</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token builtin">console</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="兼容性问题" tabindex="-1"><a class="header-anchor" href="#兼容性问题"><span>兼容性问题</span></a></h2><h3 id="q-ie-浏览器支持吗" tabindex="-1"><a class="header-anchor" href="#q-ie-浏览器支持吗"><span>Q: IE 浏览器支持吗？</span></a></h3><p><strong>A:</strong> IframeChannel 支持 IE 8+，但 Service Worker 不支持 IE。</p><p>对于 IE，需要：</p><ol><li>使用 UMD 版本</li><li>可能需要 Promise polyfill</li></ol><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html"><pre><code class="language-html"><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>postmessage-duplex.umd.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q-在-web-worker-中可以使用吗" tabindex="-1"><a class="header-anchor" href="#q-在-web-worker-中可以使用吗"><span>Q: 在 Web Worker 中可以使用吗？</span></a></h3><p><strong>A:</strong> 目前库主要针对 iframe 和 Service Worker。对于普通 Web Worker，可以使用类似的模式，但需要自行适配。</p><h2 id="其他问题" tabindex="-1"><a class="header-anchor" href="#其他问题"><span>其他问题</span></a></h2><h3 id="q-可以用于-react-native-webview-吗" tabindex="-1"><a class="header-anchor" href="#q-可以用于-react-native-webview-吗"><span>Q: 可以用于 React Native WebView 吗？</span></a></h3><p><strong>A:</strong> 原理上可行，但需要适配。React Native WebView 的 postMessage API 略有不同。</p><h3 id="q-支持双向流式通讯吗" tabindex="-1"><a class="header-anchor" href="#q-支持双向流式通讯吗"><span>Q: 支持双向流式通讯吗？</span></a></h3><p><strong>A:</strong> 当前版本主要支持请求-响应模式。对于流式通讯，可以：</p><ol><li>使用多次 publish 模拟</li><li>结合 WebSocket 使用</li><li>使用事件订阅模式</li></ol><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// 使用事件模式模拟流</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&#39;streamData&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">handleChunk</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line">  <span class="token comment">// 不返回值，表示还有更多数据</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&#39;streamEnd&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">handleStreamEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span> complete<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p>还有问题？欢迎在 <a href="https://github.com/ljquan/postmessage-duplex/issues" target="_blank" rel="noopener noreferrer">GitHub Issues</a> 提问！</p>`,73)])])}const i=s(t,[["render",l]]),u=JSON.parse('{"path":"/faq/","title":"常见问题","lang":"zh-CN","frontmatter":{},"git":{"updatedTime":1769418463000,"contributors":[{"name":"liquidliang","username":"liquidliang","email":"ljquan@qq.com","commits":1,"url":"https://github.com/liquidliang"}],"changelog":[{"hash":"288e378422593e39667c397bec9bbbf25465b67a","time":1769418463000,"email":"ljquan@qq.com","author":"liquidliang","message":"init"}]},"filePathRelative":"faq/README.md"}');export{i as comp,u as data};
