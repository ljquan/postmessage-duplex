import{_ as s,c as a,a as e,o as p}from"./app-BZDL3wne.js";const t={};function l(c,n){return p(),a("div",null,[...n[0]||(n[0]=[e(`<h1 id="错误处理" tabindex="-1"><a class="header-anchor" href="#错误处理"><span>错误处理</span></a></h1><p>postmessage-duplex 提供了结构化的错误处理机制。</p><h2 id="channelerror" tabindex="-1"><a class="header-anchor" href="#channelerror"><span>ChannelError</span></a></h2><p>自定义错误类，包含错误码和详细信息。</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">ChannelError</span> <span class="token keyword">extends</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token doc-comment comment">/** 错误码 */</span></span>
<span class="line">  code<span class="token operator">:</span> ErrorCode</span>
<span class="line">  </span>
<span class="line">  <span class="token doc-comment comment">/** 详细信息 */</span></span>
<span class="line">  details<span class="token operator">?</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span>
<span class="line">  </span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span></span>
<span class="line">    message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> </span>
<span class="line">    code<span class="token operator">:</span> ErrorCode<span class="token punctuation">,</span> </span>
<span class="line">    details<span class="token operator">?</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line">  </span>
<span class="line">  <span class="token doc-comment comment">/** 转换为 JSON 对象 */</span></span>
<span class="line">  <span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    name<span class="token operator">:</span> <span class="token builtin">string</span></span>
<span class="line">    message<span class="token operator">:</span> <span class="token builtin">string</span></span>
<span class="line">    code<span class="token operator">:</span> ErrorCode</span>
<span class="line">    details<span class="token operator">?</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="示例" tabindex="-1"><a class="header-anchor" href="#示例"><span>示例</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> ChannelError<span class="token punctuation">,</span> ErrorCode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;postmessage-duplex&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&#39;test&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token keyword">instanceof</span> <span class="token class-name">ChannelError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;错误码:&#39;</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>code<span class="token punctuation">)</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;错误信息:&#39;</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;详细信息:&#39;</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>details<span class="token punctuation">)</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;JSON:&#39;</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="errorcode" tabindex="-1"><a class="header-anchor" href="#errorcode"><span>ErrorCode</span></a></h2><p>错误码枚举。</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">enum</span> ErrorCode <span class="token punctuation">{</span></span>
<span class="line">  <span class="token doc-comment comment">/** 通道已销毁 */</span></span>
<span class="line">  ConnectionDestroyed <span class="token operator">=</span> <span class="token string">&#39;CONNECTION_DESTROYED&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  </span>
<span class="line">  <span class="token doc-comment comment">/** 连接超时 */</span></span>
<span class="line">  ConnectionTimeout <span class="token operator">=</span> <span class="token string">&#39;CONNECTION_TIMEOUT&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  </span>
<span class="line">  <span class="token doc-comment comment">/** 方法调用超时 */</span></span>
<span class="line">  MethodCallTimeout <span class="token operator">=</span> <span class="token string">&#39;METHOD_CALL_TIMEOUT&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  </span>
<span class="line">  <span class="token doc-comment comment">/** 方法未找到 */</span></span>
<span class="line">  MethodNotFound <span class="token operator">=</span> <span class="token string">&#39;METHOD_NOT_FOUND&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  </span>
<span class="line">  <span class="token doc-comment comment">/** 传输失败 */</span></span>
<span class="line">  TransmissionFailed <span class="token operator">=</span> <span class="token string">&#39;TRANSMISSION_FAILED&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  </span>
<span class="line">  <span class="token doc-comment comment">/** 消息大小超限 */</span></span>
<span class="line">  MessageSizeExceeded <span class="token operator">=</span> <span class="token string">&#39;MESSAGE_SIZE_EXCEEDED&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  </span>
<span class="line">  <span class="token doc-comment comment">/** 速率限制 */</span></span>
<span class="line">  RateLimitExceeded <span class="token operator">=</span> <span class="token string">&#39;RATE_LIMIT_EXCEEDED&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  </span>
<span class="line">  <span class="token doc-comment comment">/** 处理器错误 */</span></span>
<span class="line">  HandlerError <span class="token operator">=</span> <span class="token string">&#39;HANDLER_ERROR&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  </span>
<span class="line">  <span class="token doc-comment comment">/** 无效消息 */</span></span>
<span class="line">  InvalidMessage <span class="token operator">=</span> <span class="token string">&#39;INVALID_MESSAGE&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  </span>
<span class="line">  <span class="token doc-comment comment">/** Origin 不匹配 */</span></span>
<span class="line">  OriginMismatch <span class="token operator">=</span> <span class="token string">&#39;ORIGIN_MISMATCH&#39;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="错误码说明" tabindex="-1"><a class="header-anchor" href="#错误码说明"><span>错误码说明</span></a></h3><table><thead><tr><th>错误码</th><th>描述</th><th>常见原因</th></tr></thead><tbody><tr><td><code>ConnectionDestroyed</code></td><td>通道已被销毁</td><td>在调用 <code>destroy()</code> 后继续使用通道</td></tr><tr><td><code>ConnectionTimeout</code></td><td>连接建立超时</td><td>iframe 加载失败或 Service Worker 未就绪</td></tr><tr><td><code>MethodCallTimeout</code></td><td>方法调用超时</td><td>远程处理时间过长或未响应</td></tr><tr><td><code>MethodNotFound</code></td><td>方法未找到</td><td>远程端未订阅该事件</td></tr><tr><td><code>TransmissionFailed</code></td><td>传输失败</td><td>postMessage 调用失败</td></tr><tr><td><code>MessageSizeExceeded</code></td><td>消息大小超限</td><td>消息超过 <code>maxMessageSize</code> 设置</td></tr><tr><td><code>RateLimitExceeded</code></td><td>速率限制</td><td>消息发送频率超过 <code>rateLimit</code> 设置</td></tr><tr><td><code>HandlerError</code></td><td>处理器错误</td><td>远程回调函数抛出异常</td></tr><tr><td><code>InvalidMessage</code></td><td>无效消息</td><td>消息格式不正确</td></tr><tr><td><code>OriginMismatch</code></td><td>Origin 不匹配</td><td>消息来源与预期 origin 不一致</td></tr></tbody></table><h2 id="工厂函数" tabindex="-1"><a class="header-anchor" href="#工厂函数"><span>工厂函数</span></a></h2><h3 id="createconnectiondestroyederror" tabindex="-1"><a class="header-anchor" href="#createconnectiondestroyederror"><span>createConnectionDestroyedError</span></a></h3><p>创建连接已销毁错误。</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">function</span> <span class="token function">createConnectionDestroyedError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ChannelError</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>示例：</strong></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createConnectionDestroyedError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;postmessage-duplex&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span>isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">throw</span> <span class="token function">createConnectionDestroyedError</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="createtimeouterror" tabindex="-1"><a class="header-anchor" href="#createtimeouterror"><span>createTimeoutError</span></a></h3><p>创建超时错误。</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">function</span> <span class="token function">createTimeoutError</span><span class="token punctuation">(</span></span>
<span class="line">  cmdname<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> </span>
<span class="line">  timeout<span class="token operator">:</span> <span class="token builtin">number</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> ChannelError</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>示例：</strong></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createTimeoutError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;postmessage-duplex&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">throw</span> <span class="token function">createTimeoutError</span><span class="token punctuation">(</span><span class="token string">&#39;getData&#39;</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// ChannelError: Method call &#39;getData&#39; timed out after 5000ms</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="createhandlererror" tabindex="-1"><a class="header-anchor" href="#createhandlererror"><span>createHandlerError</span></a></h3><p>创建处理器错误。</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">function</span> <span class="token function">createHandlerError</span><span class="token punctuation">(</span></span>
<span class="line">  cmdname<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> </span>
<span class="line">  originalError<span class="token operator">:</span> Error</span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> ChannelError</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>示例：</strong></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createHandlerError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;postmessage-duplex&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">await</span> <span class="token function">handler</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">throw</span> <span class="token function">createHandlerError</span><span class="token punctuation">(</span><span class="token string">&#39;getData&#39;</span><span class="token punctuation">,</span> error <span class="token keyword">as</span> Error<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="错误处理最佳实践" tabindex="-1"><a class="header-anchor" href="#错误处理最佳实践"><span>错误处理最佳实践</span></a></h2><h3 id="基于返回码的处理" tabindex="-1"><a class="header-anchor" href="#基于返回码的处理"><span>基于返回码的处理</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> ReturnCode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;postmessage-duplex&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&#39;getData&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">switch</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">case</span> ReturnCode<span class="token punctuation">.</span>Success<span class="token operator">:</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;成功:&#39;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>data<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">break</span></span>
<span class="line">    </span>
<span class="line">  <span class="token keyword">case</span> ReturnCode<span class="token punctuation">.</span>TimeOut<span class="token operator">:</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;请求超时，请稍后重试&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">break</span></span>
<span class="line">    </span>
<span class="line">  <span class="token keyword">case</span> ReturnCode<span class="token punctuation">.</span>NoSubscribe<span class="token operator">:</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;远程端未处理此请求&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">break</span></span>
<span class="line">    </span>
<span class="line">  <span class="token keyword">case</span> ReturnCode<span class="token punctuation">.</span>ReceiverCallbackError<span class="token operator">:</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;远程处理错误:&#39;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>msg<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">break</span></span>
<span class="line">    </span>
<span class="line">  <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;未知错误:&#39;</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="基于异常的处理" tabindex="-1"><a class="header-anchor" href="#基于异常的处理"><span>基于异常的处理</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> ChannelError<span class="token punctuation">,</span> ErrorCode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;postmessage-duplex&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&#39;getData&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token keyword">instanceof</span> <span class="token class-name">ChannelError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">switch</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">case</span> ErrorCode<span class="token punctuation">.</span>ConnectionDestroyed<span class="token operator">:</span></span>
<span class="line">        <span class="token comment">// 重新创建通道</span></span>
<span class="line">        channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IframeChannel</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line">        </span>
<span class="line">      <span class="token keyword">case</span> ErrorCode<span class="token punctuation">.</span>MethodCallTimeout<span class="token operator">:</span></span>
<span class="line">        <span class="token comment">// 重试或提示用户</span></span>
<span class="line">        <span class="token function">showRetryDialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line">        </span>
<span class="line">      <span class="token keyword">case</span> ErrorCode<span class="token punctuation">.</span>RateLimitExceeded<span class="token operator">:</span></span>
<span class="line">        <span class="token comment">// 延迟重试</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">retry</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line">        </span>
<span class="line">      <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">        <span class="token comment">// 记录错误</span></span>
<span class="line">        <span class="token function">logError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 非通道错误</span></span>
<span class="line">    <span class="token keyword">throw</span> error</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="类型守卫" tabindex="-1"><a class="header-anchor" href="#类型守卫"><span>类型守卫</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">function</span> <span class="token function">isChannelError</span><span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> error <span class="token keyword">is</span> ChannelError <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> error <span class="token keyword">instanceof</span> <span class="token class-name">ChannelError</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">isTimeoutError</span><span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">isChannelError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> error<span class="token punctuation">.</span>code <span class="token operator">===</span> ErrorCode<span class="token punctuation">.</span>MethodCallTimeout</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 使用</span></span>
<span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&#39;test&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTimeoutError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 处理超时</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="统一错误处理" tabindex="-1"><a class="header-anchor" href="#统一错误处理"><span>统一错误处理</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">ChannelClient</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">private</span> channel<span class="token operator">:</span> IframeChannel</span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">async</span> <span class="token generic-function"><span class="token function">request</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>cmdname<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> data<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>channel<span class="token punctuation">.</span>isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">throw</span> <span class="token function">createConnectionDestroyedError</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>channel<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>cmdname<span class="token punctuation">,</span> data<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>ret <span class="token operator">===</span> ReturnCode<span class="token punctuation">.</span>Success<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> response<span class="token punctuation">.</span>data <span class="token keyword">as</span> <span class="token constant">T</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 统一转换为 ChannelError</span></span>
<span class="line">    <span class="token keyword">throw</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createError</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">private</span> <span class="token function">createError</span><span class="token punctuation">(</span>response<span class="token operator">:</span> PostResponse<span class="token punctuation">)</span><span class="token operator">:</span> ChannelError <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">switch</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">case</span> ReturnCode<span class="token punctuation">.</span>TimeOut<span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ChannelError</span><span class="token punctuation">(</span></span>
<span class="line">          <span class="token string">&#39;Request timed out&#39;</span><span class="token punctuation">,</span></span>
<span class="line">          ErrorCode<span class="token punctuation">.</span>MethodCallTimeout</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">      <span class="token keyword">case</span> ReturnCode<span class="token punctuation">.</span>NoSubscribe<span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ChannelError</span><span class="token punctuation">(</span></span>
<span class="line">          <span class="token string">&#39;Method not found&#39;</span><span class="token punctuation">,</span></span>
<span class="line">          ErrorCode<span class="token punctuation">.</span>MethodNotFound</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">      <span class="token keyword">case</span> ReturnCode<span class="token punctuation">.</span>ReceiverCallbackError<span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ChannelError</span><span class="token punctuation">(</span></span>
<span class="line">          response<span class="token punctuation">.</span>msg <span class="token operator">||</span> <span class="token string">&#39;Handler error&#39;</span><span class="token punctuation">,</span></span>
<span class="line">          ErrorCode<span class="token punctuation">.</span>HandlerError</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">      <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ChannelError</span><span class="token punctuation">(</span></span>
<span class="line">          response<span class="token punctuation">.</span>msg <span class="token operator">||</span> <span class="token string">&#39;Unknown error&#39;</span><span class="token punctuation">,</span></span>
<span class="line">          ErrorCode<span class="token punctuation">.</span>TransmissionFailed</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,37)])])}const o=s(t,[["render",l]]),r=JSON.parse('{"path":"/api/errors.html","title":"错误处理","lang":"zh-CN","frontmatter":{},"git":{"updatedTime":1769418463000,"contributors":[{"name":"liquidliang","username":"liquidliang","email":"ljquan@qq.com","commits":1,"url":"https://github.com/liquidliang"}],"changelog":[{"hash":"288e378422593e39667c397bec9bbbf25465b67a","time":1769418463000,"email":"ljquan@qq.com","author":"liquidliang","message":"init"}]},"filePathRelative":"api/errors.md"}');export{o as comp,r as data};
