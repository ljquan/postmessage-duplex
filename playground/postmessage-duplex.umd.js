var e,t;e=this,t=function(e){"use strict";const t="postmessage-duplex",i="1.0.0",s="undefined"!=typeof window?window:"undefined"!=typeof self?self:{};var r,n;s.__POSTMESSAGE_DUPLEX__||(s.__POSTMESSAGE_DUPLEX__={}),s.__POSTMESSAGE_DUPLEX__.version=i,s.__POSTMESSAGE_DUPLEX__.name=t,e.ReturnCode=void 0,(r=e.ReturnCode||(e.ReturnCode={}))[r.Success=0]="Success",r[r.ReceiverCallbackError=-1]="ReceiverCallbackError",r[r.SendCallbackError=-2]="SendCallbackError",r[r.NoSubscribe=-3]="NoSubscribe",r[r.TimeOut=-99]="TimeOut",e.ErrorCode=void 0,(n=e.ErrorCode||(e.ErrorCode={})).ConnectionDestroyed="CONNECTION_DESTROYED",n.ConnectionTimeout="CONNECTION_TIMEOUT",n.MethodCallTimeout="METHOD_CALL_TIMEOUT",n.MethodNotFound="METHOD_NOT_FOUND",n.TransmissionFailed="TRANSMISSION_FAILED",n.MessageSizeExceeded="MESSAGE_SIZE_EXCEEDED",n.RateLimitExceeded="RATE_LIMIT_EXCEEDED",n.HandlerError="HANDLER_ERROR",n.InvalidMessage="INVALID_MESSAGE",n.OriginMismatch="ORIGIN_MISMATCH";class o extends Error{constructor(e,t,i){super(e),Object.defineProperty(this,"code",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"details",{enumerable:1,configurable:1,writable:1,value:void 0}),this.name="ChannelError",this.code=t,this.details=i,Error.captureStackTrace&&Error.captureStackTrace(this,o)}toJSON(){return{name:this.name,message:this.message,code:this.code,details:this.details,stack:this.stack}}}class a{constructor(){Object.defineProperty(this,"timeouts",{enumerable:1,configurable:1,writable:1,value:new Map}),Object.defineProperty(this,"timer",{enumerable:1,configurable:1,writable:1,value:null}),Object.defineProperty(this,"nextDeadline",{enumerable:1,configurable:1,writable:1,value:1/0}),Object.defineProperty(this,"destroyed",{enumerable:1,configurable:1,writable:1,value:0})}add(e,t,i){if(this.destroyed)return;const s=Date.now()+t;this.timeouts.set(e,{deadline:s,callback:i}),s<this.nextDeadline&&this.reschedule(s)}remove(e){return this.timeouts.delete(e)}has(e){return this.timeouts.has(e)}get size(){return this.timeouts.size}reschedule(e){null!==this.timer&&clearTimeout(this.timer),this.nextDeadline=e;const t=Math.max(0,e-Date.now());this.timer=setTimeout(()=>this.processTimeouts(),t)}processTimeouts(){if(this.destroyed)return;const e=Date.now(),t=[];for(const[i,{deadline:s,callback:r}]of this.timeouts)s<=e&&(t.push(r),this.timeouts.delete(i));for(const e of t)try{e()}catch(e){console.error("[TimeoutManager] Callback error:",e)}this.scheduleNext()}scheduleNext(){if(0===this.timeouts.size)return this.nextDeadline=1/0,void(this.timer=null);let e=1/0;for(const{deadline:t}of this.timeouts.values())t<e&&(e=t);e<1/0&&this.reschedule(e)}destroy(){this.destroyed=1,null!==this.timer&&(clearTimeout(this.timer),this.timer=null),this.timeouts.clear(),this.nextDeadline=1/0}clear(){null!==this.timer&&(clearTimeout(this.timer),this.timer=null),this.timeouts.clear(),this.nextDeadline=1/0}}class h{constructor(e,t=1e3){Object.defineProperty(this,"limit",{enumerable:1,configurable:1,writable:1,value:e}),Object.defineProperty(this,"windowMs",{enumerable:1,configurable:1,writable:1,value:t}),Object.defineProperty(this,"timestamps",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"head",{enumerable:1,configurable:1,writable:1,value:0}),Object.defineProperty(this,"tail",{enumerable:1,configurable:1,writable:1,value:0}),Object.defineProperty(this,"count",{enumerable:1,configurable:1,writable:1,value:0}),Object.defineProperty(this,"enabled",{enumerable:1,configurable:1,writable:1,value:void 0}),this.enabled=e>0,this.timestamps=this.enabled?new Array(e).fill(0):[]}tryAcquire(){if(!this.enabled)return 1;const e=Date.now(),t=e-this.windowMs;for(;this.count>0&&this.timestamps[this.head]<=t;)this.head=(this.head+1)%this.limit,this.count--;return this.count>=this.limit?0:(this.timestamps[this.tail]=e,this.tail=(this.tail+1)%this.limit,this.count++,1)}getCurrentCount(){if(!this.enabled)return 0;const e=Date.now()-this.windowMs;let t=0,i=this.head;for(let s=0;s<this.count;s++)this.timestamps[i]>e&&t++,i=(i+1)%this.limit;return t}getRemainingCapacity(){return this.enabled?Math.max(0,this.limit-this.getCurrentCount()):1/0}getTimeUntilAvailable(){if(!this.enabled||this.count<this.limit)return 0;const e=Date.now()-this.windowMs;let t=this.head;for(;t!==this.tail;){if(this.timestamps[t]>e)return this.timestamps[t]-e;t=(t+1)%this.limit}return 0}isLimited(){return this.enabled?this.getCurrentCount()>=this.limit:0}reset(){this.head=0,this.tail=0,this.count=0,this.enabled&&this.timestamps.fill(0)}getLimit(){return this.limit}getWindowMs(){return this.windowMs}isEnabled(){return this.enabled}}class l{constructor(){Object.defineProperty(this,"eventHandlers",{enumerable:1,configurable:1,writable:1,value:new Map}),Object.defineProperty(this,"eventsEnabled",{enumerable:1,configurable:1,writable:1,value:1})}on(e,t){let i=this.eventHandlers.get(e);return i||(i=new Set,this.eventHandlers.set(e,i)),i.add(t),()=>{i?.delete(t),0===i?.size&&this.eventHandlers.delete(e)}}once(e,t){const i=s=>{this.off(e,i),t(s)};return this.on(e,i)}off(e,t){const i=this.eventHandlers.get(e);if(!i)return 0;const s=i.delete(t);return 0===i.size&&this.eventHandlers.delete(e),s}offAll(e){e?this.eventHandlers.delete(e):this.eventHandlers.clear()}emit(e,t){if(!this.eventsEnabled)return;const i=this.eventHandlers.get(e);if(i)for(const s of[...i])try{s(t)}catch(t){console.error(`[ChannelEventEmitter] Error in ${e} handler:`,t)}}hasListeners(e){const t=this.eventHandlers.get(e);return void 0!==t&&t.size>0}listenerCount(e){return this.eventHandlers.get(e)?.size??0}setEventsEnabled(e){this.eventsEnabled=e}destroyEventEmitter(){this.eventHandlers.clear(),this.eventsEnabled=0}}function c(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function u(e){return"string"==typeof e&&e.length>0}const d=e=>({valid:0,error:e});function b(t){if(!c(t))return d("Message must be an object");const i=t,s="requestId"in i,r="cmdname"in i,n="msg"in i,o="ret"in i;return s||r||n?s&&"string"!=typeof i.requestId?d("requestId must be a string"):r&&"string"!=typeof i.cmdname?d("cmdname must be a string"):n&&"string"!=typeof i.msg?d("msg must be a string"):!o||"number"==typeof(a=i.ret)&&Object.values(e.ReturnCode).includes(a)?"data"in i&&void 0!==i.data&&!c(i.data)?d("data must be an object"):"t"in i&&void 0!==i.t&&"string"!=typeof i.t?d("_senderKey must be a string"):!("time"in i)||void 0===i.time||"number"==typeof i.time&&Number.isFinite(i.time)?{valid:1,message:i}:d("time must be a finite number"):d("ret must be a valid ReturnCode"):d("Message must have requestId, cmdname, or msg field");var a}function m(e){return"ret"in e&&"number"==typeof e.ret}function g(e){return"ready"===e.msg}function f(e){try{const t=JSON.stringify(e);return"undefined"!=typeof Blob?new Blob([t]).size:2*t.length}catch{return 1/0}}const v="undefined"!=typeof window?window:"undefined"!=typeof self?self:{},w=[],p=[],y={totalSent:0,totalReceived:0,timeouts:0,errors:0,activeChannels:0};let O=0;function S(e){p.length>=200&&p.shift(),p.push(e)}function E(e,t){for(let i=p.length-1;i>=0;i--)if(p[i].requestId===e&&"pending"===p[i].status){p[i].status=t,p[i].duration=Date.now()-p[i].timestamp;break}}function M(){const e=new Date;return`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}:${String(e.getSeconds()).padStart(2,"0")}.${String(e.getMilliseconds()).padStart(3,"0")}`}function C(e,t,i,s=0){const r=M();console.log(`%c[${r}] ${"send"===e?"üì§":"üì•"} ${"send"===e?"‚Üí":"‚Üê"} ${t||i}${s?" (response)":""}`,`color: ${"send"===e?"#2196F3":"#4CAF50"}; font-weight: bold`)}class j{help(){console.log(`\n%c‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n‚ïë           PostMessage Channel Debugger v${i.padEnd(10)}          ‚ïë\n‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n‚ïë  Available Commands:                                         ‚ïë\n‚ïë                                                              ‚ïë\n‚ïë  debug.help()              - Show this help message          ‚ïë\n‚ïë  debug.getChannels()       - List all active channels        ‚ïë\n‚ïë  debug.getHistory(opts?)   - View message history            ‚ïë\n‚ïë  debug.enableLiveLog(bool) - Toggle real-time logging        ‚ïë\n‚ïë  debug.getPending()        - List pending requests           ‚ïë\n‚ïë  debug.getStats()          - Show statistics                 ‚ïë\n‚ïë  debug.exportReport()      - Export debug report as JSON     ‚ïë\n‚ïë  debug.clear()             - Clear history and stats         ‚ïë\n‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`,"color: #2196F3; font-family: monospace")}getChannels(){const e=[],t=[];for(const i of w){const s=i.deref();if(s){t.push(i);const r={type:s.channelType||"unknown",isReady:s.isReady,isDestroyed:s.isDestroyed||0,baseKey:s.baseKey||"",peerKey:s.getPeerKey(),pendingCount:s.getPendingCount(),subscriptions:Array.from(s.subscribeMap?.keys()||[])};"function"==typeof s.getTargetOrigin&&(r.targetOrigin=s.getTargetOrigin()),e.push(r)}}return w.length=0,w.push(...t),y.activeChannels=t.length,0===e.length?console.log("%cNo active channels found.","color: #999"):e.forEach((e,t)=>{const i=e.isDestroyed?"#999":e.isReady?"#4CAF50":"#FF9800";console.log(`\n%cChannel #${t+1} (${e.type})\n%c‚îú‚îÄ Status: ${e.isDestroyed?"üíÄ":e.isReady?"‚úì":"‚è≥"} ${e.isDestroyed?"Destroyed":e.isReady?"Ready":"Connecting"}\n‚îú‚îÄ BaseKey: ${e.baseKey}\n‚îú‚îÄ PeerKey: ${e.peerKey||"(not paired)"}\n‚îú‚îÄ Pending: ${e.pendingCount} requests\n‚îú‚îÄ Subscriptions: ${e.subscriptions.join(", ")||"(none)"}\n${e.targetOrigin?`‚îî‚îÄ Target: ${e.targetOrigin}`:"‚îî‚îÄ (no target info)"}`,"color: #2196F3; font-weight: bold",`color: ${i}`)}),e}getHistory(e){let t=[...p];if(e?.filter){const i=e.filter.toLowerCase();t=t.filter(e=>e.cmdname.toLowerCase().includes(i)||e.requestId.toLowerCase().includes(i))}if(e?.limit&&e.limit>0&&(t=t.slice(-e.limit)),0===t.length)console.log("%cNo message history.","color: #999");else{const e=t.map(e=>({Dir:"send"===e.direction?"‚Üí":"‚Üê",Command:e.cmdname||e.requestId.slice(-8),Status:"ok"===e.status?"‚úì":"timeout"===e.status?"‚è±":"error"===e.status?"‚úó":"...",Time:void 0!==e.duration?`${e.duration}ms`:"-",Timestamp:new Date(e.timestamp).toLocaleTimeString("en-US",{hour12:0})}));console.table(e)}return t}enableLiveLog(e){O=e,e?console.log("%cüî¥ Live logging ENABLED. Messages will appear in real-time.","color: #4CAF50; font-weight: bold"):console.log("%c‚ö™ Live logging DISABLED.","color: #999")}getPending(){const e=[];return w.forEach((t,i)=>{const s=t.deref();if(s){const t=s.requestCmdMap;if(t)for(const[s,r]of t)e.push({channelIndex:i,requestId:s,cmdname:r})}}),0===e.length?console.log("%cNo pending requests.","color: #999"):console.table(e),e}getStats(){return console.log(`\n%c‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n‚ïë     PostMessage Channel Statistics   ‚ïë\n‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n‚ïë  üì§ Total Sent:      ${String(y.totalSent).padStart(10)}     ‚ïë\n‚ïë  üì• Total Received:  ${String(y.totalReceived).padStart(10)}     ‚ïë\n‚ïë  ‚è±  Timeouts:        ${String(y.timeouts).padStart(10)}     ‚ïë\n‚ïë  ‚ùå Errors:          ${String(y.errors).padStart(10)}     ‚ïë\n‚ïë  üì° Active Channels: ${String(y.activeChannels).padStart(10)}     ‚ïë\n‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`,"color: #2196F3; font-family: monospace"),{...y}}exportReport(){const e={version:i,name:t,timestamp:(new Date).toISOString(),stats:{...y},channels:this.getChannels(),history:p.slice(-100),pending:this.getPending()},s=JSON.stringify(e,null,2);return console.log("%cDebug report exported. Use copy() to copy to clipboard.","color: #4CAF50"),s}clear(){p.length=0,y.totalSent=0,y.totalReceived=0,y.timeouts=0,y.errors=0,console.log("%cHistory and stats cleared.","color: #999")}isLiveLogEnabled(){return O}}let I=null;function $(e){const t=Date.now().toString(36);let i;if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(2);crypto.getRandomValues(e),i=e[0].toString(36)+e[1].toString(36)}else i=Math.floor(1e10*Math.random()).toString(36);return`${e}${t}${i}_`}class T extends l{constructor(e){if(super(),Object.defineProperty(this,"baseKey",{enumerable:1,configurable:1,writable:1,value:""}),Object.defineProperty(this,"peerKey",{enumerable:1,configurable:1,writable:1,value:""}),Object.defineProperty(this,"reqTime",{enumerable:1,configurable:1,writable:1,value:0}),Object.defineProperty(this,"callbackMap",{enumerable:1,configurable:1,writable:1,value:new Map}),Object.defineProperty(this,"subscribeMap",{enumerable:1,configurable:1,writable:1,value:new Map}),Object.defineProperty(this,"timeout",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"isReady",{enumerable:1,configurable:1,writable:1,value:0}),Object.defineProperty(this,"isDestroyed",{enumerable:1,configurable:1,writable:1,value:0}),Object.defineProperty(this,"postTasks",{enumerable:1,configurable:1,writable:1,value:new Map}),Object.defineProperty(this,"bindOnMessage",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"console",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"maxMessageSize",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"timeoutManager",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"rateLimiter",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"strictValidation",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"requestCmdMap",{enumerable:1,configurable:1,writable:1,value:new Map}),this.timeout=e?.timeout??5e3,this.console=e?.log??("undefined"!=typeof window?window.console:console),this.maxMessageSize=e?.maxMessageSize??1048576,this.strictValidation=e?.strictValidation??1,this.timeoutManager=new a,this.rateLimiter=new h(e?.rateLimit??100,1e3),e?.subscribeMap)for(const t in e.subscribeMap)this.subscribeMap.set(t,e.subscribeMap[t]);var t;this.bindOnMessage=this.onMessage.bind(this),t=this,w.push(new WeakRef(t)),y.activeChannels++,t.on("message:sent",({cmdname:e,requestId:t})=>{y.totalSent++,S({direction:"send",cmdname:e,requestId:t,status:"pending",timestamp:Date.now(),dataSummary:""}),O&&C("send",e,t)}),t.on("message:received",({cmdname:e,requestId:t,isResponse:i})=>{y.totalReceived++;const s=e||"",r=t||"";i?E(r,"ok"):S({direction:"receive",cmdname:s,requestId:r,status:"ok",timestamp:Date.now(),dataSummary:""}),O&&C("receive",s,r,i)}),t.on("timeout",({cmdname:e,requestId:t})=>{y.timeouts++,E(t,"timeout"),O&&function(e,t){const i=M();console.log(`%c[${i}] ‚è± TIMEOUT: ${e||t}`,"color: #FF9800; font-weight: bold")}(e,t)}),t.on("error",({context:e})=>{y.errors++,O&&function(e){const t=M();console.log(`%c[${t}] ‚ùå ERROR: ${e}`,"color: #F44336; font-weight: bold")}(e||"unknown")}),t.on("destroy",()=>{y.activeChannels=Math.max(0,y.activeChannels-1)})}checkRateLimit(){if(!this.rateLimiter.isEnabled())return 1;if(!this.rateLimiter.tryAcquire()){const e=this.rateLimiter.getCurrentCount(),t=this.rateLimiter.getLimit();return this.log("warn","Rate limit exceeded:",e,"/",t,"messages per second"),this.emit("rate:limited",{currentCount:e,limit:t}),0}return 1}validateMessageSize(t){if(this.maxMessageSize<=0)return;const i=f(t);if(i>this.maxMessageSize){const t=new o(`Message size (${i} bytes) exceeds limit (${this.maxMessageSize} bytes)`,e.ErrorCode.MessageSizeExceeded,{size:i,limit:this.maxMessageSize});throw this.emit("error",{error:t,context:"validateMessageSize"}),t}}init(){this.setupMessageListener(),this.sendMessage({requestId:this.baseKey+this.reqTime,msg:"ready",t:this.baseKey})}log(e,...t){this.console?.[e]?.(`[${this.channelType}]: `,...t)}isFromPeer(e){return this.peerKey?e.t&&e.t!==this.peerKey?(this.log("log","Message from non-paired channel, ignored",e.t,"expected:",this.peerKey),0):m(e)&&e.requestId&&!e.requestId.startsWith(this.baseKey)?0:1:1}sendMessage(e,t){this.validateMessageSize(e),this.checkRateLimit()?(e.time=Date.now(),e.t=this.baseKey,this.sendRawMessage(e,t)):this.log("warn","Message dropped due to rate limiting")}async onMessage(t){if(this.log("log","onMessage",t.data),!this.isValidSource(t))return;if(this.strictValidation){const e=b(t.data);if(!e.valid)return this.log("warn","Invalid message structure:",e.error),void this.emit("validation:failed",{reason:e.error,data:t.data})}const i=t.data;if(!i)return;if(!this.isFromPeer(i))return;this.emit("message:received",{cmdname:i.cmdname||"",requestId:i.requestId||"",isResponse:m(i)});const{requestId:s,cmdname:r,t:n}=i,o=s?this.callbackMap.get(s):void 0;if(o&&s)return this.timeoutManager.remove(s),this.requestCmdMap.delete(s),o.resolve(i),void this.deleteCallback(s);if(r){const t=this.subscribeMap.get(r);if(t){try{const r=await t(i);this.sendMessage({requestId:s,ret:e.ReturnCode.Success,data:r})}catch(t){const n=t instanceof Error?t.message:String(t);this.sendMessage({req:i,requestId:s,ret:e.ReturnCode.ReceiverCallbackError,msg:n||"unknown error"}),this.emit("error",{error:t instanceof Error?t:new Error(n),context:`handler:${r}`})}return}}if(g(i))return n&&!this.peerKey&&(this.peerKey=n,this.log("log","Point-to-point pairing established","self:",this.baseKey,"peer:",this.peerKey)),this.isReady=1,this.executePosts(),this.emit("ready",{peerKey:this.peerKey}),void(m(i)||this.sendMessage({requestId:s,ret:e.ReturnCode.Success,msg:"ready"}));s&&!m(i)&&(this.log("warn","No registered handler for:",r||s),this.sendMessage({requestId:s,ret:e.ReturnCode.NoSubscribe}))}postMessage(e,t){try{this.sendMessage(e,t),this.emit("message:sent",{cmdname:e.cmdname||"",requestId:e.requestId||""})}catch(t){this.log("error",t,e),this.emit("error",{error:t instanceof Error?t:new Error(String(t)),context:"postMessage"})}}publish(t,i,s){if(this.isDestroyed)return Promise.reject(new o("Cannot publish: channel has been destroyed",e.ErrorCode.ConnectionDestroyed,{cmdname:t}));const r=this.baseKey+ ++this.reqTime,n={requestId:r,cmdname:t,data:i};this.requestCmdMap.set(r,t);const a=new Promise((e,t)=>{this.callbackMap.set(r,{resolve:e,reject:t})});return this.log("log","publish",this.isReady,this.postTasks.size),this.isReady?this.doPublish(n,s):this.postTasks.set(r,{data:n,prm:a,options:s}),a}doPublish(t,i){const{requestId:s,cmdname:r}=t,n=i?.timeout??this.timeout;this.timeoutManager.add(s,n,()=>{const i=this.callbackMap.get(s);if(i){const o={req:t,requestId:s,ret:e.ReturnCode.TimeOut,time:Date.now(),msg:"timeout"};this.log("error","postmessage timeout",o),this.emit("timeout",{requestId:s,cmdname:r,timeoutMs:n}),i.resolve(o),this.deleteCallback(s),this.requestCmdMap.delete(s)}}),this.postMessage(t,i?.transferables)}deleteCallback(e){this.callbackMap.delete(e),this.postTasks.delete(e),this.timeoutManager.remove(e)}executePosts(){for(const e of this.postTasks.values())this.doPublish(e.data,e.options)}call(e,t,i){return this.publish(e,t,i)}subscribe(e,t){return this.subscribeMap.has(e)&&this.log("warn",`${e} has been subscribed`),this.subscribeMap.set(e,t),this}unSubscribe(e){return this.subscribeMap.delete(e),this}subscribeOnce(e,t){return this.subscribe(e,async i=>(this.unSubscribe(e),t(i)))}getPeerKey(){return this.peerKey}getRateLimitStats(){return{current:this.rateLimiter.getCurrentCount(),limit:this.rateLimiter.getLimit(),remaining:this.rateLimiter.getRemainingCapacity()}}getPendingCount(){return this.callbackMap.size}destroy(){if(this.isDestroyed)return;this.isDestroyed=1,this.emit("destroy",{reason:"explicit"}),function(e){const t=w.findIndex(t=>t.deref()===e);-1!==t&&w.splice(t,1)}(this);const t=new o("Channel has been destroyed",e.ErrorCode.ConnectionDestroyed);for(const[i,s]of this.callbackMap)try{s.reject({ret:e.ReturnCode.SendCallbackError,msg:t.message})}catch(e){this.log("warn","Error rejecting pending request:",i,e)}this.removeMessageListener(),this.subscribeMap.clear(),this.postTasks.clear(),this.callbackMap.clear(),this.requestCmdMap.clear(),this.timeoutManager.destroy(),this.rateLimiter.reset(),this.destroyEventEmitter(),this.isReady=0,this.peerKey=""}}function D(e){const t=document.createElement("div");t.innerHTML="<a/>";const i=t.firstChild;return i.href=e,i}class q extends T{constructor(e,t){if(super(t),Object.defineProperty(this,"channelType",{enumerable:1,configurable:1,writable:1,value:"ServiceWorkerChannel"}),Object.defineProperty(this,"isWorkerSide",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"worker",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"clientId",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"swContainer",{enumerable:1,configurable:1,writable:1,value:void 0}),this.isWorkerSide=t?.isWorkerSide??0,this.isWorkerSide){if("string"!=typeof e)throw new Error("Service Worker Á´ØÂøÖÈ°ª‰º†ÂÖ• clientId Â≠óÁ¨¶‰∏≤");this.clientId=e,this.baseKey=$("sw_")}else{if(!e||"string"==typeof e)throw new Error("È°µÈù¢Á´ØÂøÖÈ°ª‰º†ÂÖ•ÊúâÊïàÁöÑ ServiceWorker ÂÆû‰æã");this.worker=e,this.swContainer=navigator.serviceWorker,this.baseKey=$("page_")}this.log("log","baseKey",this.baseKey,this.isWorkerSide?"worker":"page"),this.init()}setupMessageListener(){this.isWorkerSide?self.addEventListener("message",this.bindOnMessage):this.swContainer?.addEventListener("message",this.bindOnMessage)}removeMessageListener(){this.isWorkerSide?self.removeEventListener("message",this.bindOnMessage):this.swContainer?.removeEventListener("message",this.bindOnMessage)}sendRawMessage(e,t){try{const i=JSON.parse(JSON.stringify(e));this.isWorkerSide?this.sendToClient(i,t):t&&t.length>0?this.worker?.postMessage(i,t):this.worker?.postMessage(i)}catch(t){this.log("error","sendMessage error",t,e)}}async sendToClient(e,t){const i=this.clientId;if(i)try{const s=await self.clients.get(i);s?t&&t.length>0?s.postMessage(e,t):s.postMessage(e):this.log("warn","Client not found:",i)}catch(e){this.log("error","sendToClient error",e)}else this.log("error","No clientId available")}isValidSource(e){if(this.isWorkerSide){const t=e.source;return t?.id===this.clientId}return 1}log(e,...t){const i=this.isWorkerSide?"worker":"page";this.console?.[e]?.(`[ServiceWorkerChannel](${i}): `,...t)}getClientId(){return this.clientId}isWorkerAvailable(){return this.isWorkerSide||"activated"===this.worker?.state}static async createFromPage(e){if(!("serviceWorker"in navigator))throw new Error("Service Worker is not supported in this browser");const t=(await navigator.serviceWorker.ready).active||navigator.serviceWorker.controller;if(!t)throw new Error("No active Service Worker found");return new q(t,e)}static createFromWorker(e,t){return new q(e,{...t,isWorkerSide:1})}static createFromEvent(e,t){const i=e.source;if(!i?.id)throw new Error("Invalid message event: no client source");return q.createFromWorker(i.id,t)}}e.BaseChannel=T,e.ChannelError=o,e.ChannelEventEmitter=l,e.IframeChannel=class extends T{constructor(e,t){if(super(t),Object.defineProperty(this,"channelType",{enumerable:1,configurable:1,writable:1,value:"IframeChannel"}),Object.defineProperty(this,"isSon",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"link",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"targetOrigin",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"url",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"iframe",{enumerable:1,configurable:1,writable:1,value:void 0}),"string"==typeof e){this.isSon=1,this.url=e,this.link=D(e),this.targetOrigin=this.link.origin;const t=D(document.referrer).origin;if(this.targetOrigin!==t)throw new Error(`Áà∂È°µÈù¢ ${document.referrer} ÈùûÊåáÂÆöÂüüÂêçÁöÑÈ°µÈù¢ ${e} ÔºÅ`);this.baseKey=$("son_")}else this.isSon=0,this.iframe=e,this.url=e.src,this.link=D(this.url),this.targetOrigin=this.link.origin,this.baseKey=$("parent_");this.log("log","baseKey",this.baseKey,this.isSon),this.init()}setupMessageListener(){window.addEventListener("message",this.bindOnMessage,1)}removeMessageListener(){window.removeEventListener("message",this.bindOnMessage,1)}sendRawMessage(e,t){try{if(this.isSon){const i=JSON.parse(JSON.stringify(e));t&&t.length>0?parent.postMessage(i,this.targetOrigin,t):parent.postMessage(i,this.targetOrigin)}else t&&t.length>0?this.iframe.contentWindow.postMessage(e,this.targetOrigin,t):this.iframe.contentWindow.postMessage(e,this.targetOrigin)}catch(t){this.log("error",t,e,this.targetOrigin)}}isValidSource(e){return e.origin!==this.targetOrigin?(this.log("log","Êú™Â§ÑÁêÜ",e.data,e,"ÈùûÁõÆÊ†áÊ∫ê:",this.targetOrigin),0):this.isSon||e.source===this.iframe?.contentWindow?1:0}log(e,...t){this.console?.[e]?.(`[${this.targetOrigin||"IframeChannel"}](${this.isSon?"son":"parent"}): `,...t)}getTargetOrigin(){return this.targetOrigin}getTargetUrl(){return this.url}},e.PKG_NAME=t,e.PKG_VERSION=i,e.ServiceWorkerChannel=q,e.SlidingWindowRateLimiter=h,e.TimeoutManager=a,e.createConnectionDestroyedError=function(t){return new o("Channel has been destroyed",e.ErrorCode.ConnectionDestroyed,t?{requestId:t}:void 0)},e.createHandlerError=function(t,i){return new o(i.message||`Handler for "${t}" threw an error`,e.ErrorCode.HandlerError,{cmdname:t,originalError:i.message,stack:i.stack})},e.createTimeoutError=function(t,i){return new o(`Request "${t}" timed out after ${i}ms`,e.ErrorCode.MethodCallTimeout,{cmdname:t,timeout:i})},e.enableDebugger=function(){return I||(I=new j),v.__POSTMESSAGE_DUPLEX__||(v.__POSTMESSAGE_DUPLEX__={}),Object.defineProperty(v.__POSTMESSAGE_DUPLEX__,"debug",{value:I,writable:0,configurable:1}),console.log("%cüîß PostMessage Debugger enabled. Type __POSTMESSAGE_DUPLEX__.debug.help() for commands.","color: #4CAF50; font-weight: bold"),I},e.estimateMessageSize=f,e.getDebugger=function(){return I},e.isDebuggerEnabled=function(){return null!==I&&void 0!==v.__POSTMESSAGE_DUPLEX__?.debug},e.isReadyMessage=g,e.isResponseMessage=m,e.sanitizeForLogging=function(e){const t={};for(const i of["requestId","cmdname","ret","msg","time","_senderKey"])i in e&&(t[i]=e[i]);if("data"in e&&void 0!==e.data)try{t.data=JSON.parse(JSON.stringify(e.data))}catch{t.data="[Unserializable]"}return t},e.validateMessage=b,e.validateRequest=function(e){const t=b(e);return t.valid?u(t.message.requestId)?u(t.message.cmdname)?t:d("Request must have a non-empty cmdname"):d("Request must have a non-empty requestId"):t},e.validateResponse=function(e){const t=b(e);return t.valid?"ret"in t.message?t:d("Response must have a ret field"):t}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).PostMessageChannel={});
//# sourceMappingURL=index.umd.js.map
