<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­é¡µé¢ - postmessage-duplex Playground</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 15px;
      min-height: 100%;
      color: white;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    h2 {
      font-size: 16px;
      font-weight: 600;
    }
    
    .badge {
      background: rgba(255,255,255,0.2);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
    }
    
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      background: rgba(255,255,255,0.9);
      color: #667eea;
      transition: all 0.2s;
    }
    
    button:hover {
      background: white;
      transform: translateY(-1px);
    }
    
    .log-container {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 12px;
      height: 150px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 12px;
    }
    
    .log-item {
      padding: 3px 0;
      opacity: 0.9;
    }
    
    .log-time {
      opacity: 0.7;
    }
    
    .log-send {
      color: #a5d6a7;
    }
    
    .log-receive {
      color: #90caf9;
    }
    
    .log-error {
      color: #ef9a9a;
    }
    
    .code-hint {
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
      padding: 10px;
      margin-top: 10px;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 11px;
      line-height: 1.4;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>ğŸ“± å­é¡µé¢ (iframe)</h2>
    <span class="badge">child.html</span>
  </div>
  
  <div class="controls">
    <button onclick="sendToParent()">å‘é€æ¶ˆæ¯ç»™çˆ¶é¡µé¢</button>
    <button onclick="sendPing()">å‘é€ Ping</button>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
  </div>
  
  <div class="log-container" id="logContainer"></div>
  
  <div class="code-hint">
    <span style="color:#a5d6a7">// å­é¡µé¢ä»£ç ç¤ºä¾‹</span><br>
    const channel = new IframeChannel(parentOrigin)<br>
    channel.subscribe('greeting', ({data}) => data)<br>
    channel.publish('notify', {msg: 'Hi!'})
  </div>

  <script src="./postmessage-duplex.umd.js"></script>
  <script>
    const logContainer = document.getElementById('logContainer');
    let channel;
    
    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const item = document.createElement('div');
      item.className = 'log-item';
      item.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
      logContainer.appendChild(item);
      logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    function clearLog() {
      logContainer.innerHTML = '';
      log('æ—¥å¿—å·²æ¸…ç©º');
    }
    
    // åˆå§‹åŒ–
    try {
      const { IframeChannel } = PostMessageChannel;
      
      // è·å–çˆ¶é¡µé¢ origin
      const parentOrigin = window.location.origin;
      channel = new IframeChannel(parentOrigin, {
        timeout: 5000
      });
      
      log('âœ… é€šé“å·²åˆ›å»º');
      
      // ç›‘å¬çˆ¶é¡µé¢æ¶ˆæ¯
      channel.subscribe('greeting', ({ data }) => {
        log('ğŸ“¨ æ”¶åˆ°é—®å€™: ' + data.message, 'receive');
        return { 
          reply: 'Hello from child!',
          originalMessage: data.message,
          time: Date.now()
        };
      });
      
      channel.subscribe('getData', ({ data }) => {
        log('ğŸ“¨ æ”¶åˆ°æ•°æ®è¯·æ±‚: id=' + data.id, 'receive');
        // æ¨¡æ‹Ÿæ•°æ®
        return {
          id: data.id,
          name: 'Item ' + data.id,
          price: Math.floor(Math.random() * 1000),
          timestamp: Date.now()
        };
      });
      
      channel.subscribe('slowOperation', async ({ data }) => {
        log('ğŸ“¨ æ”¶åˆ°æ…¢æ“ä½œè¯·æ±‚ï¼Œå»¶è¿Ÿ 5 ç§’...', 'receive');
        // æ•…æ„å»¶è¿Ÿï¼Œè®©çˆ¶é¡µé¢è¶…æ—¶
        await new Promise(resolve => setTimeout(resolve, 5000));
        return { completed: true };
      });
      
      // é€šçŸ¥çˆ¶é¡µé¢å­é¡µé¢å·²å°±ç»ª
      setTimeout(() => {
        channel.publish('childReady', { 
          status: 'ready',
          time: Date.now()
        }).then(response => {
          if (response.ret === 0) {
            log('ğŸ‰ çˆ¶é¡µé¢å·²ç¡®è®¤è¿æ¥', 'send');
          }
        });
      }, 100);
      
    } catch (error) {
      log('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
    }
    
    async function sendToParent() {
      log('ğŸ“¤ å‘é€æ¶ˆæ¯ç»™çˆ¶é¡µé¢', 'send');
      
      try {
        const response = await channel.publish('notify', {
          type: 'notification',
          content: 'Hello from child!',
          time: Date.now()
        });
        
        if (response.ret === 0) {
          log('âœ… çˆ¶é¡µé¢å·²ç¡®è®¤: ' + JSON.stringify(response.data), 'receive');
        } else {
          log('âš ï¸ å“åº”é”™è¯¯: ' + response.msg, 'error');
        }
      } catch (error) {
        log('âŒ å‘é€å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    async function sendPing() {
      log('ğŸ“¤ å‘é€ Ping', 'send');
      
      try {
        const start = Date.now();
        const response = await channel.publish('ping', {});
        const latency = Date.now() - start;
        
        if (response.ret === 0 && response.data.pong) {
          log(`ğŸ“ æ”¶åˆ° Pong! å»¶è¿Ÿ: ${latency}ms`, 'receive');
        } else {
          log('âš ï¸ Ping å¤±è´¥', 'error');
        }
      } catch (error) {
        log('âŒ Ping å¤±è´¥: ' + error.message, 'error');
      }
    }
  </script>
</body>
</html>
