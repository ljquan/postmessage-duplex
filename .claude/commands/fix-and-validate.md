# Fix and Validate

自动修复代码问题并验证，循环直到所有检查通过。

## 说明

这个命令实现了 Boris Cherny 第 12 条技巧：让 Claude 自动循环改进工作直到完成。适用于需要反复修复的场景。

## 参数

- `$ARGUMENTS`: 可选，指定要检查的范围（如特定文件或目录）

## 工作流程

```
┌─────────────────┐
│  运行验证命令    │
└────────┬────────┘
         │
         ▼
    ┌────────────┐
    │  检查结果   │
    └────────┬───┘
         │
    ┌────┴────┐
    │ 有错误? │
    └────┬────┘
         │
    Yes  │  No
    ┌────┴────┐
    │         │
    ▼         ▼
┌────────┐  ┌────────┐
│ 修复   │  │ 完成   │
└────┬───┘  └────────┘
     │
     └──────────────┐
                    │
         (最多 5 次循环)
```

## 步骤

### 循环开始 (最多 5 次)

#### 1. 类型检查

```bash
nx typecheck drawnix 2>&1
```

如果失败:
- 解析错误信息
- 定位问题文件和行号
- 应用修复
- 记录修复内容

#### 2. Lint 检查

```bash
nx lint drawnix --fix 2>&1
```

如果仍有错误:
- 手动修复无法自动修复的问题
- 记录修复内容

#### 3. 测试检查

```bash
nx test drawnix --passWithNoTests 2>&1
```

如果失败:
- 分析失败的测试
- 修复代码或更新测试
- 记录修复内容

#### 4. 构建检查

```bash
npm run build:web 2>&1
```

如果失败:
- 分析构建错误
- 修复问题
- 记录修复内容

### 循环结束条件

- 所有检查通过
- 达到最大循环次数 (5 次)
- 遇到无法自动修复的问题

### 生成报告

```markdown
## Fix and Validate 报告

### 循环次数: N/5

### 修复记录

| 轮次 | 问题类型 | 文件 | 修复内容 |
|------|---------|------|---------|
| 1 | TypeScript | xxx.ts:10 | 添加类型定义 |
| 1 | ESLint | yyy.tsx:25 | 移除未使用变量 |
| 2 | Test | zzz.test.ts | 更新测试断言 |

### 最终状态

| 检查项 | 状态 |
|--------|------|
| 类型检查 | ✅ |
| Lint | ✅ |
| 测试 | ✅ |
| 构建 | ✅ |

### 下一步

建议运行 `/auto-commit` 提交这些修复。
```

## 安全限制

- 最多循环 5 次，防止无限循环
- 不修改测试逻辑（只修复明显的断言错误）
- 不删除文件
- 保留修复记录以便审查

## 使用场景

1. 大规模重构后的验证修复
2. 依赖升级后的兼容性修复
3. 代码格式化后的类型修复
4. CI 失败后的本地修复

## 注意事项

- 修复过程中会修改代码，请确保在版本控制下工作
- 如果问题过于复杂，会停止并请求人工介入
- 某些问题可能需要设计决策，不会自动修复
