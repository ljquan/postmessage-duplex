---
name: PostMessage å¯è§‚æµ‹æ€§å¢å¼º
overview: é€šè¿‡å¢å¼ºå†…ç½®è°ƒè¯•å·¥å…·ã€ä¸°å¯Œ Console è¾“å‡ºæ ¼å¼ã€æ·»åŠ å…¨å±€è°ƒè¯•å‘½ä»¤ï¼Œå¤§å¹…é™ä½ postMessage é€šä¿¡é—®é¢˜çš„è°ƒè¯•é—¨æ§›ï¼Œé¢„è®¡ 1-2 å¤©å®Œæˆã€‚
todos:
  - id: create-debugger
    content: åˆ›å»º src/debugger.ts è°ƒè¯•å·¥å…·æ¨¡å—
    status: completed
  - id: enhance-trace
    content: æ‰©å±• trace.ts æ”¯æŒæ›´å¤šå…ƒä¿¡æ¯
    status: completed
  - id: register-channels
    content: ä¿®æ”¹ base-channel.ts æ³¨å†Œé€šé“åˆ°è°ƒè¯•å™¨
    status: completed
  - id: export-debugger
    content: åœ¨ index.ts ä¸­å¯¼å‡ºè°ƒè¯•å·¥å…·
    status: completed
isProject: false
---

# PostMessage å¯è§‚æµ‹æ€§å¢å¼ºæ–¹æ¡ˆ

## èƒŒæ™¯åˆ†æ

å½“å‰ç—›ç‚¹ï¼š

- `__postmessage_duplex_getTrace()` è¾“å‡ºåŸå§‹ JSONï¼Œéš¾ä»¥å¿«é€Ÿå®šä½é—®é¢˜
- æ¶ˆæ¯æµå‘ä¸ç›´è§‚ï¼Œè¯·æ±‚-å“åº”éš¾ä»¥é…å¯¹
- ç¼ºä¹å®æ—¶ç›‘æ§ï¼Œåªèƒ½äº‹åæŸ¥çœ‹

## æ ¸å¿ƒåŸåˆ™

### 1. é›¶æ€§èƒ½å¼€é”€

**å…³é”®çº¦æŸ**ï¼šè°ƒè¯•åŠŸèƒ½åœ¨æœªä¸»åŠ¨å¯ç”¨æ—¶ï¼Œä¸äº§ç”Ÿä»»ä½•è¿è¡Œæ—¶å¼€é”€ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ€§èƒ½ä¿è¯                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ“ æƒ°æ€§åˆå§‹åŒ– - åªåœ¨é¦–æ¬¡è®¿é—® debug å¯¹è±¡æ—¶åˆ›å»ºå®ä¾‹           â”‚
â”‚  âœ“ é»˜è®¤å…³é—­ - å®æ—¶æ—¥å¿—ç­‰åŠŸèƒ½éœ€æ‰‹åŠ¨å¼€å¯                      â”‚
â”‚  âœ“ é›¶ä¾µå…¥ - ä¸ä¿®æ”¹ç°æœ‰ä»£ç çƒ­è·¯å¾„                            â”‚
â”‚  âœ“ æŒ‰éœ€æ‰§è¡Œ - æ‰€æœ‰æ–¹æ³•åªåœ¨è°ƒç”¨æ—¶æ‰æ‰§è¡Œ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ˜¾å¼å¯ç”¨ï¼ˆå®‰å…¨ç­–ç•¥ï¼‰

**å…³é”®çº¦æŸ**ï¼šè°ƒè¯•åŠŸèƒ½é»˜è®¤ä¸æš´éœ²ï¼Œéœ€è¦å¼€å‘è€…åœ¨ä»£ç ä¸­æ˜¾å¼å¯ç”¨ã€‚

```typescript
// é»˜è®¤æƒ…å†µä¸‹ï¼Œ__POSTMESSAGE_DUPLEX__.debug æ˜¯ undefined
// å¿…é¡»å…ˆè°ƒç”¨ enableDebugger() æ‰èƒ½ä½¿ç”¨è°ƒè¯•åŠŸèƒ½

import { enableDebugger } from '@jt/postmessage-channel'

// åªåœ¨å¼€å‘ç¯å¢ƒå¯ç”¨
if (process.env.NODE_ENV === 'development') {
  enableDebugger()
}

// æˆ–è€…åœ¨éœ€è¦è°ƒè¯•æ—¶æ‰‹åŠ¨å¯ç”¨
// enableDebugger()

// å¯ç”¨åæ‰èƒ½ä½¿ç”¨
// __POSTMESSAGE_DUPLEX__.debug.getHistory()
```

**å®‰å…¨ä¼˜åŠ¿**ï¼š

- ç”Ÿäº§ç¯å¢ƒé»˜è®¤ä¸æš´éœ²è°ƒè¯•æ¥å£
- å³ä½¿ä»£ç ä¸­åŒ…å«è°ƒè¯•æ¨¡å—ï¼Œæœªè°ƒç”¨ `enableDebugger()` åˆ™å®Œå…¨ä¸å¯è®¿é—®
- å¼€å‘è€…å¯ä»¥æ ¹æ®ç¯å¢ƒå˜é‡æ§åˆ¶æ˜¯å¦å¯ç”¨

## æ–¹æ¡ˆè®¾è®¡

### 1. æƒ°æ€§åˆå§‹åŒ–çš„è°ƒè¯•å¯¹è±¡

```typescript
// ä½¿ç”¨ getter å®ç°æƒ°æ€§åˆå§‹åŒ–
let debugInstance: ChannelDebugger | null = null

Object.defineProperty(globalScope.__POSTMESSAGE_DUPLEX__, 'debug', {
  get() {
    // åªåœ¨é¦–æ¬¡è®¿é—®æ—¶åˆå§‹åŒ–ï¼Œæ­£å¸¸ä½¿ç”¨å®Œå…¨é›¶å¼€é”€
    if (!debugInstance) {
      debugInstance = new ChannelDebugger()
    }
    return debugInstance
  },
  configurable: true
})
```

### 2. é€šé“æ³¨å†Œï¼ˆé›¶å¼€é”€å®ç°ï¼‰

```typescript
// ä½¿ç”¨ WeakSet å­˜å‚¨é€šé“å¼•ç”¨ï¼Œä¸é˜»æ­¢ GC
const channels = new WeakSet<BaseChannel>()
const channelRefs: WeakRef<BaseChannel>[] = []  // ç”¨äºéå†

// åœ¨ BaseChannel æ„é€ å‡½æ•°ä¸­æ·»åŠ ä¸€è¡Œï¼ˆå‡ ä¹é›¶å¼€é”€ï¼‰
registerChannel(this)  // ä»…æ˜¯ WeakSet.add() æ“ä½œ
```

### 3. å®æ—¶æ—¥å¿—ï¼ˆé»˜è®¤å…³é—­ï¼‰

```typescript
class ChannelDebugger {
  private liveLogEnabled = false  // é»˜è®¤å…³é—­
  
  enableLiveLog(enabled: boolean) {
    this.liveLogEnabled = enabled
    if (enabled) {
      // åªåœ¨å¼€å¯æ—¶æ³¨å†Œç›‘å¬
      this.hookTraceSystem()
    } else {
      this.unhookTraceSystem()
    }
  }
}

// ç°æœ‰ addTrace å‡½æ•°ä¿æŒä¸å˜
// é€šè¿‡å¯é€‰çš„å›è°ƒé’©å­å®ç°ï¼Œæœªå¼€å¯æ—¶æ— ä»»ä½•å¼€é”€
```

### 4. è°ƒè¯• API è®¾è®¡

```typescript
window.__POSTMESSAGE_DUPLEX__.debug = {
  // æŸ¥çœ‹å¸®åŠ©
  help(): void,
  
  // è·å–æ‰€æœ‰æ´»è·ƒé€šé“
  getChannels(): ChannelInfo[],
  
  // æŸ¥çœ‹æ¶ˆæ¯å†å²ï¼ˆå¸¦æ ¼å¼åŒ–è¾“å‡ºï¼‰
  getHistory(options?: { limit?: number, filter?: string }): void,
  
  // å¼€å¯/å…³é—­å®æ—¶æ—¥å¿—ï¼ˆé»˜è®¤å…³é—­ï¼‰
  enableLiveLog(enabled: boolean): void,
  
  // æŸ¥çœ‹å¾…å¤„ç†è¯·æ±‚
  getPending(): PendingRequest[],
  
  // æ€§èƒ½ç»Ÿè®¡
  getStats(): ChannelStats,
  
  // å¯¼å‡ºè°ƒè¯•æŠ¥å‘Šï¼ˆJSON æ ¼å¼ï¼Œå¯åˆ†äº«ï¼‰
  exportReport(): string
}
```

### 5. Console è¾“å‡ºç¤ºä¾‹

**æ¶ˆæ¯å†å²ï¼ˆgetHistoryï¼‰**ï¼š

```
// console.table æ ¼å¼åŒ–è¾“å‡º
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   â”‚ Dir    â”‚ Command    â”‚ Status   â”‚ Time    â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0 â”‚ â†’      â”‚ getData    â”‚ âœ“ OK     â”‚ 33ms    â”‚
â”‚ 1 â”‚ â†’      â”‚ setConfig  â”‚ â± Timeoutâ”‚ 5000ms  â”‚
â”‚ 2 â”‚ â†      â”‚ onEvent    â”‚ âœ“ OK     â”‚ 2ms     â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®æ—¶æ—¥å¿—ï¼ˆenableLiveLogï¼‰**ï¼š

```
[10:30:15.123] ğŸ“¤ â†’ getData {id: 123}
[10:30:15.156] ğŸ“¥ â† getData âœ“ 33ms
[10:30:21.000] ğŸ“¤ â†’ setConfig â± TIMEOUT
```

**é€šé“çŠ¶æ€ï¼ˆgetChannelsï¼‰**ï¼š

```
Channel #1 (IframeChannel - Parent)
â”œâ”€ Status: Ready âœ“
â”œâ”€ Peer: son_m1abc123xyz_
â”œâ”€ Target: https://child.example.com
â”œâ”€ Pending: 0 requests
â””â”€ Subscriptions: getData, setConfig
```

## æ€§èƒ½å¼€é”€åˆ†æ

| æ“ä½œ | æœªå¯ç”¨è°ƒè¯•æ—¶ | å¯ç”¨è°ƒè¯•å |

|------|-------------|-----------|

| åˆ›å»ºé€šé“ | +1 WeakSet.add() | åŒå·¦ |

| å‘é€æ¶ˆæ¯ | æ— é¢å¤–å¼€é”€ | +1 å›è°ƒï¼ˆå¦‚å¼€å¯å®æ—¶æ—¥å¿—ï¼‰|

| æ¥æ”¶æ¶ˆæ¯ | æ— é¢å¤–å¼€é”€ | +1 å›è°ƒï¼ˆå¦‚å¼€å¯å®æ—¶æ—¥å¿—ï¼‰|

| å†…å­˜å ç”¨ | +çº¦ 1KBï¼ˆä»£ç ï¼‰| +æ¶ˆæ¯å†å²ç¼“å­˜ |

## æ–‡ä»¶å˜æ›´

### æ–°å¢æ–‡ä»¶

- `src/debugger.ts` - è°ƒè¯•å·¥å…·æ¨¡å—ï¼ˆçº¦ 250 è¡Œï¼‰
  - `enableDebugger()` - å¯ç”¨è°ƒè¯•åŠŸèƒ½çš„å…¥å£å‡½æ•°
  - `ChannelDebugger` ç±» - è°ƒè¯•åŠŸèƒ½å®ç°
  - é€šé“æ³¨å†Œ/æ³¨é”€é€»è¾‘

### ä¿®æ”¹æ–‡ä»¶

- `src/trace.ts` - æ·»åŠ å¯é€‰å›è°ƒé’©å­ï¼ˆçº¦ +10 è¡Œï¼‰
- `src/base-channel.ts` - æ·»åŠ é€šé“æ³¨å†Œï¼ˆçº¦ +5 è¡Œï¼‰
- `src/index.ts` - å¯¼å‡º `enableDebugger` å‡½æ•°

## ä½¿ç”¨æ–¹å¼

### æ­¥éª¤ 1ï¼šåœ¨ä»£ç ä¸­å¯ç”¨è°ƒè¯•å™¨

```typescript
// åœ¨åº”ç”¨å…¥å£æ–‡ä»¶ä¸­
import { enableDebugger } from '@jt/postmessage-channel'

// æ¨èï¼šåªåœ¨å¼€å‘ç¯å¢ƒå¯ç”¨
if (process.env.NODE_ENV === 'development') {
  enableDebugger()
}

// æˆ–è€…ï¼šé€šè¿‡ URL å‚æ•°æ§åˆ¶
if (new URLSearchParams(location.search).has('debug')) {
  enableDebugger()
}
```

### æ­¥éª¤ 2ï¼šåœ¨ Console ä¸­ä½¿ç”¨

```javascript
// åœ¨ Chrome DevTools Console ä¸­

// 1. æŸ¥çœ‹å¸®åŠ©
__POSTMESSAGE_DUPLEX__.debug.help()

// 2. å¼€å¯å®æ—¶æ—¥å¿—è§‚å¯Ÿæ¶ˆæ¯æµ
__POSTMESSAGE_DUPLEX__.debug.enableLiveLog(true)

// 3. æŸ¥çœ‹å†å²æ¶ˆæ¯
__POSTMESSAGE_DUPLEX__.debug.getHistory({ limit: 50 })

// 4. æŸ¥çœ‹é€šé“çŠ¶æ€
__POSTMESSAGE_DUPLEX__.debug.getChannels()

// 5. å¯¼å‡ºè°ƒè¯•æŠ¥å‘Š
copy(__POSTMESSAGE_DUPLEX__.debug.exportReport())
```

### ç”Ÿäº§ç¯å¢ƒä¸´æ—¶è°ƒè¯•

å¦‚æœéœ€è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸´æ—¶è°ƒè¯•ï¼ˆä¸æ¨èå¸¸è§„ä½¿ç”¨ï¼‰ï¼š

```javascript
// æ–¹æ³• 1ï¼šå¦‚æœä»£ç ä¸­æœ‰æ¡ä»¶å¯ç”¨é€»è¾‘
// è®¿é—® https://your-app.com?debug

// æ–¹æ³• 2ï¼šåœ¨ Console ä¸­æ‰‹åŠ¨å¯ç”¨ï¼ˆéœ€è¦ä»£ç ä¸­å¯¼å…¥äº† enableDebuggerï¼‰
// æ­¤æ–¹æ³•éœ€è¦æ„å»ºæ—¶ä¿ç•™è°ƒè¯•ä»£ç 
```

## ä¼˜åŠ¿æ€»ç»“

- **é›¶å¼€é”€** - æœªå¯ç”¨æ—¶å®Œå…¨ä¸å½±å“æ€§èƒ½
- **å®‰å…¨** - æ˜¾å¼å¯ç”¨æœºåˆ¶ï¼Œç”Ÿäº§ç¯å¢ƒé»˜è®¤ä¸æš´éœ²è°ƒè¯•æ¥å£
- **è½»é‡çº§** - çº¦ 250 è¡Œä»£ç ï¼Œgzip åçº¦ 2KB
- **ç›´è§‚** - å½©è‰²è¾“å‡ºã€è¡¨æ ¼å±•ç¤ºã€å®æ—¶ç›‘æ§
- **å¯åˆ†äº«** - å¯¼å‡ºæŠ¥å‘Šä¾¿äºè¿œç¨‹ååŠ©æ’æŸ¥